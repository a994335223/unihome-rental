<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>客户收藏管理 - 管理后台</title>
    <!-- 本地CSS资源加载 -->
    <link href="/static/css/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/all.min.css">
    <link rel="stylesheet" href="/static/css/admin.css">

    <style>
        /* 移除页面初始隐藏，提升加载速度 */

        /* 加载动画 */
        .dashboard-loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(180deg, #4b6cb7 0%, #182848 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        .dashboard-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(255,255,255,0.3);
            border-top: 3px solid #ffffff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        .dashboard-loader-text {
            color: #ffffff;
            font-size: 16px;
            font-weight: 500;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* 侧边栏渐变背景 */
        .bg-sidebar {
            background: linear-gradient(180deg, #4b6cb7 0%, #182848 100%);
        }

        /* 表格样式 */
        .table-container {
            max-height: 600px;
            overflow-y: auto;
        }

        .favorite-row:hover {
            background-color: #f8fafc;
        }

        /* 统计卡片样式 */
        .stat-card {
            transition: transform 0.2s ease-in-out;
        }

        .stat-card:hover {
            transform: translateY(-2px);
        }
    </style>
</head>
<body class="bg-gray-100 font-sans flex h-screen">
    <!-- 仪表盘加载动画 -->
    <div class="dashboard-loader" id="dashboardLoader">
        <div class="dashboard-spinner"></div>
        <div class="dashboard-loader-text">客户收藏管理加载中...</div>
    </div>

    <!-- 侧边栏 -->
    <aside class="bg-sidebar text-white w-64 space-y-6 py-7 px-2 absolute inset-y-0 left-0 transform -translate-x-full md:relative md:translate-x-0 transition duration-200 ease-in-out">
        <div class="flex items-center justify-center space-x-2">
            <i class="fas fa-home text-white text-2xl"></i>
            <span class="text-2xl font-extrabold">管理后台</span>
        </div>
        <nav>
            <a href="/admin/dashboard" class="block py-2.5 px-4 rounded transition duration-200 hover:bg-blue-800">
                <i class="fas fa-home fa-fw mr-3"></i>控制台
            </a>
            <a href="/admin/properties" class="block py-2.5 px-4 rounded transition duration-200 hover:bg-blue-800">
                <i class="fas fa-building fa-fw mr-3"></i>房源管理
            </a>
            <a href="/admin/appointments" class="block py-2.5 px-4 rounded transition duration-200 hover:bg-blue-800">
                <i class="fas fa-calendar-check fa-fw mr-3"></i>预约管理
                <span id="appointmentBadge" class="ml-2 bg-red-500 text-white text-xs px-2 py-1 rounded-full hidden">0</span>
            </a>
            <a href="/admin/customer_favorites" class="block py-2.5 px-4 rounded transition duration-200 bg-blue-700 hover:bg-blue-800">
                <i class="fas fa-heart fa-fw mr-3"></i>客户收藏
            </a>
            <a href="/admin/locations" class="block py-2.5 px-4 rounded transition duration-200 hover:bg-blue-800">
                <i class="fas fa-map-marker-alt fa-fw mr-3"></i>位置管理
            </a>
            <a href="/admin/property_types" class="block py-2.5 px-4 rounded transition duration-200 hover:bg-blue-800">
                <i class="fas fa-home fa-fw mr-3"></i>房屋类型
            </a>
            <a href="/admin/profile" class="block py-2.5 px-4 rounded transition duration-200 hover:bg-blue-800">
                <i class="fas fa-user fa-fw mr-3"></i>个人资料
            </a>
            <a href="#" class="block py-2.5 px-4 rounded transition duration-200 hover:bg-blue-800">
                <i class="fas fa-chart-line fa-fw mr-3"></i>统计分析
            </a>
            <a href="#" class="block py-2.5 px-4 rounded transition duration-200 hover:bg-blue-800">
                <i class="fas fa-cog fa-fw mr-3"></i>系统设置
            </a>
        </nav>
    </aside>

    <!-- 主要内容区域 -->
    <div class="flex flex-col flex-1 overflow-hidden">
        <!-- 顶部导航栏 -->
        <header class="flex justify-between items-center py-4 px-6 bg-white border-b-4 border-indigo-600 shadow">
            <div>
                <h1 class="text-2xl font-semibold text-gray-800">客户收藏管理</h1>
                <p class="text-gray-600">查看和管理客户收藏的房源信息</p>
            </div>
            <div class="flex items-center space-x-4">
                <span class="text-gray-600">{{ user.display_name or user.email }}</span>
                <a href="/admin/logout" class="text-red-600 hover:text-red-800">
                    <i class="fas fa-sign-out-alt"></i> 退出
                </a>
            </div>
        </header>

        <!-- 主内容区 -->
        <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-200 p-6">
            <!-- 统计概览 -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                <div class="stat-card bg-white rounded-lg shadow p-6">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-blue-500 bg-opacity-75">
                            <i class="fas fa-heart text-white text-xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">总收藏数</p>
                            <p id="totalFavorites" class="text-2xl font-semibold text-gray-900">-</p>
                        </div>
                    </div>
                </div>
                
                <div class="stat-card bg-white rounded-lg shadow p-6">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-green-500 bg-opacity-75">
                            <i class="fas fa-calendar-day text-white text-xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">今日新增</p>
                            <p id="todayFavorites" class="text-2xl font-semibold text-gray-900">-</p>
                        </div>
                    </div>
                </div>
                
                <div class="stat-card bg-white rounded-lg shadow p-6">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-yellow-500 bg-opacity-75">
                            <i class="fas fa-chart-line text-white text-xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">本周新增</p>
                            <p id="weekFavorites" class="text-2xl font-semibold text-gray-900">-</p>
                        </div>
                    </div>
                </div>
                
                <div class="stat-card bg-white rounded-lg shadow p-6">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-purple-500 bg-opacity-75">
                            <i class="fas fa-fire text-white text-xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">热门房源</p>
                            <p id="popularCount" class="text-2xl font-semibold text-gray-900">-</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 筛选器 -->
            <div class="bg-white rounded-lg shadow p-6 mb-6">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">搜索</label>
                        <input type="text" id="searchInput" placeholder="客户姓名、邮箱或房源名称" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">开始日期</label>
                        <input type="date" id="dateFrom" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">结束日期</label>
                        <input type="date" id="dateTo" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div class="flex items-end space-x-2">
                        <button onclick="searchFavorites()" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition duration-200">
                            <i class="fas fa-search mr-2"></i>搜索
                        </button>
                        <button onclick="resetFilters()" class="px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600 transition duration-200">
                            <i class="fas fa-undo mr-2"></i>重置
                        </button>
                        <button onclick="exportFavorites()" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition duration-200">
                            <i class="fas fa-download mr-2"></i>导出
                        </button>
                    </div>
                </div>
            </div>

            <!-- 收藏列表 -->
            <div class="bg-white rounded-lg shadow">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h3 class="text-lg font-medium text-gray-900">客户收藏列表</h3>
                </div>
                
                <!-- 加载状态 -->
                <div id="loadingState" class="p-8 text-center">
                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"></div>
                    <p class="mt-2 text-gray-600">加载中...</p>
                </div>

                <!-- 表格容器 -->
                <div id="tableContainer" class="table-container hidden">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50 sticky top-0">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    客户信息
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    房源信息
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    收藏时间
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    操作
                                </th>
                            </tr>
                        </thead>
                        <tbody id="favoritesTableBody" class="bg-white divide-y divide-gray-200">
                            <!-- 数据将通过JavaScript动态填充 -->
                        </tbody>
                    </table>
                </div>

                <!-- 分页 -->
                <div id="paginationContainer" class="px-6 py-4 border-t border-gray-200 hidden">
                    <div class="flex items-center justify-between">
                        <div class="text-sm text-gray-700">
                            显示第 <span id="pageStart">1</span> 到 <span id="pageEnd">20</span> 条，共 <span id="totalCount">0</span> 条记录
                        </div>
                        <div class="flex space-x-2">
                            <button id="prevPage" onclick="changePage(-1)" class="px-3 py-1 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 disabled:opacity-50" disabled>
                                上一页
                            </button>
                            <span id="pageInfo" class="px-3 py-1 text-gray-700">第 1 页，共 1 页</span>
                            <button id="nextPage" onclick="changePage(1)" class="px-3 py-1 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 disabled:opacity-50" disabled>
                                下一页
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 空状态 -->
                <div id="emptyState" class="p-8 text-center hidden">
                    <i class="fas fa-heart text-gray-300 text-4xl mb-4"></i>
                    <p class="text-gray-600">暂无客户收藏数据</p>
                </div>
            </div>
        </main>
    </div>

    <script>
        let currentPage = 1;
        let totalPages = 1;
        let currentFilters = {};

        // 页面加载完成后立即隐藏加载动画并加载数据
        window.addEventListener('DOMContentLoaded', function() {
            // 立即隐藏加载动画，提升用户体验
            document.getElementById('dashboardLoader').style.display = 'none';
            loadAppointmentCount();
            loadStats();
            loadFavorites();
        });

        // 更新预约数量徽章
        function updateAppointmentBadge(count) {
            const badge = document.getElementById('appointmentBadge');
            if (count > 0) {
                badge.textContent = count;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }

        // 获取预约数量
        async function loadAppointmentCount() {
            try {
                const response = await fetch('/api/appointments?status=pending');
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        updateAppointmentBadge(data.data.length);
                    }
                }
            } catch (error) {
                console.error('获取预约数量失败:', error);
            }
        }

        // 加载统计数据
        async function loadStats() {
            try {
                const response = await fetch('/api/admin/customer_favorites/stats');
                const data = await response.json();
                
                if (data.success) {
                    const stats = data.data;
                    document.getElementById('totalFavorites').textContent = stats.total_favorites;
                    document.getElementById('todayFavorites').textContent = stats.today_favorites;
                    document.getElementById('weekFavorites').textContent = stats.week_favorites;
                    document.getElementById('popularCount').textContent = stats.popular_properties.length;
                }
            } catch (error) {
                console.error('加载统计数据失败:', error);
            }
        }

        // 加载收藏列表
        async function loadFavorites(page = 1) {
            try {
                showLoading();
                
                const params = new URLSearchParams({
                    page: page,
                    per_page: 20,
                    ...currentFilters
                });
                
                const response = await fetch(`/api/admin/customer_favorites?${params}`);
                const data = await response.json();
                
                if (data.success) {
                    renderFavorites(data.data);
                    renderPagination(data.pagination);
                    currentPage = page;
                    totalPages = data.pagination.pages;
                } else {
                    showError(data.message);
                }
            } catch (error) {
                console.error('加载收藏列表失败:', error);
                showError('加载收藏列表失败，请稍后再试');
            }
        }

        // 渲染收藏列表
        function renderFavorites(favorites) {
            const tbody = document.getElementById('favoritesTableBody');
            
            if (favorites.length === 0) {
                showEmpty();
                return;
            }
            
            tbody.innerHTML = favorites.map(favorite => {
                const createdAt = new Date(favorite.created_at);
                const formattedDate = createdAt.toLocaleDateString('zh-CN');
                const formattedTime = createdAt.toLocaleTimeString('zh-CN', { hour12: false });
                
                return `
                    <tr class="favorite-row">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <div class="flex-shrink-0 h-10 w-10">
                                    <div class="h-10 w-10 rounded-full bg-indigo-500 flex items-center justify-center">
                                        <i class="fas fa-user text-white"></i>
                                    </div>
                                </div>
                                <div class="ml-4">
                                    <div class="text-sm font-medium text-gray-900">${favorite.user.username}</div>
                                    <div class="text-sm text-gray-500">${favorite.user.email}</div>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <div class="flex-shrink-0 h-10 w-10">
                                    ${favorite.property.images && favorite.property.images.length > 0 
                                        ? `<img class="h-10 w-10 rounded object-cover" src="${favorite.property.images[0]}" alt="${favorite.property.name}">`
                                        : `<div class="h-10 w-10 rounded bg-gray-300 flex items-center justify-center">
                                             <i class="fas fa-home text-gray-500"></i>
                                           </div>`
                                    }
                                </div>
                                <div class="ml-4">
                                    <div class="text-sm font-medium text-gray-900">${favorite.property.name}</div>
                                    <div class="text-sm text-gray-500">${favorite.property.location}</div>
                                    <div class="text-sm text-indigo-600">${favorite.property.currency === 'CAD' ? 'C$' : '¥'}${favorite.property.price}/${favorite.property.price_unit}</div>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            <div>${formattedDate}</div>
                            <div class="text-gray-500">${formattedTime}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button onclick="contactCustomer('${favorite.user.email}', '${favorite.property.name}')" 
                                    class="text-indigo-600 hover:text-indigo-900 mr-3">
                                <i class="fas fa-envelope mr-1"></i>联系
                            </button>
                            <button onclick="viewProperty(${favorite.property.id})" 
                                    class="text-green-600 hover:text-green-900">
                                <i class="fas fa-eye mr-1"></i>查看房源
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
            
            showTable();
        }

        // 渲染分页
        function renderPagination(pagination) {
            if (pagination.total === 0) return;
            
            document.getElementById('pageStart').textContent = (pagination.page - 1) * pagination.per_page + 1;
            document.getElementById('pageEnd').textContent = Math.min(pagination.page * pagination.per_page, pagination.total);
            document.getElementById('totalCount').textContent = pagination.total;
            document.getElementById('pageInfo').textContent = `第 ${pagination.page} 页，共 ${pagination.pages} 页`;
            
            document.getElementById('prevPage').disabled = !pagination.has_prev;
            document.getElementById('nextPage').disabled = !pagination.has_next;
            
            document.getElementById('paginationContainer').classList.remove('hidden');
        }

        // 搜索收藏
        function searchFavorites() {
            const search = document.getElementById('searchInput').value.trim();
            const dateFrom = document.getElementById('dateFrom').value;
            const dateTo = document.getElementById('dateTo').value;
            
            currentFilters = {};
            if (search) currentFilters.search = search;
            if (dateFrom) currentFilters.date_from = dateFrom;
            if (dateTo) currentFilters.date_to = dateTo;
            
            loadFavorites(1);
        }

        // 重置筛选器
        function resetFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('dateFrom').value = '';
            document.getElementById('dateTo').value = '';
            currentFilters = {};
            loadFavorites(1);
        }

        // 翻页
        function changePage(direction) {
            const newPage = currentPage + direction;
            if (newPage >= 1 && newPage <= totalPages) {
                loadFavorites(newPage);
            }
        }

        // 联系客户
        function contactCustomer(email, propertyName) {
            const subject = encodeURIComponent(`关于您收藏的房源：${propertyName}`);
            const body = encodeURIComponent(`您好！\n\n我们注意到您收藏了房源"${propertyName}"，如果您有任何问题或需要更多信息，请随时联系我们。\n\n谢谢！`);
            window.open(`mailto:${email}?subject=${subject}&body=${body}`);
        }

        // 查看房源
        function viewProperty(propertyId) {
            window.open(`/#detail-${propertyId}`, '_blank');
        }

        // 导出收藏数据
        function exportFavorites() {
            const params = new URLSearchParams({
                ...currentFilters
            });
            window.open(`/api/admin/customer_favorites/export?${params}`);
        }

        // 显示状态管理
        function showLoading() {
            document.getElementById('loadingState').classList.remove('hidden');
            document.getElementById('tableContainer').classList.add('hidden');
            document.getElementById('paginationContainer').classList.add('hidden');
            document.getElementById('emptyState').classList.add('hidden');
        }

        function showTable() {
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('tableContainer').classList.remove('hidden');
            document.getElementById('emptyState').classList.add('hidden');
        }

        function showEmpty() {
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('tableContainer').classList.add('hidden');
            document.getElementById('paginationContainer').classList.add('hidden');
            document.getElementById('emptyState').classList.remove('hidden');
        }

        function showError(message) {
            console.error(message);
            showEmpty();
        }

        // 搜索框回车事件
        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchFavorites();
            }
        });
    </script>
</body>
</html>
