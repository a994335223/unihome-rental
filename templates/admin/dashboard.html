<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>租房管理平台 - 管理后台</title>
    <!-- 本地CSS资源加载 -->
    <link href="/static/css/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/all.min.css">
    <link rel="stylesheet" href="/static/css/admin.css">

    <style>
        /* 移除页面初始隐藏，提升加载速度 */

        /* 加载动画 */
        .dashboard-loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(180deg, #4b6cb7 0%, #182848 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        .dashboard-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(255,255,255,0.3);
            border-top: 3px solid #ffffff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        .dashboard-loader-text {
            color: #ffffff;
            font-size: 16px;
            font-weight: 500;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* 页面显示动画 */
        .dashboard-loaded {
            visibility: visible !important;
            opacity: 0;
            animation: fadeIn 0.5s ease-out forwards;
        }

        .dashboard-loader.hide {
            opacity: 0;
            transition: opacity 0.3s ease-out;
            pointer-events: none;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .bg-sidebar {
            background: linear-gradient(180deg, #4b6cb7 0%, #182848 100%);
        }
    </style>
</head>
<body class="bg-gray-100 font-sans flex h-screen">
    <!-- 仪表盘加载动画 -->
    <div class="dashboard-loader" id="dashboardLoader">
        <div class="dashboard-spinner"></div>
        <div class="dashboard-loader-text">仪表盘加载中...</div>
    </div>

    <!-- 侧边栏 -->
    <aside class="bg-sidebar text-white w-64 space-y-6 py-7 px-2 absolute inset-y-0 left-0 transform -translate-x-full md:relative md:translate-x-0 transition duration-200 ease-in-out">
        <div class="flex items-center justify-center space-x-2">
            <i class="fas fa-home text-white text-2xl"></i>
            <span class="text-2xl font-extrabold">管理后台</span>
        </div>
        <nav>
            <a href="/admin/dashboard" class="block py-2.5 px-4 rounded transition duration-200 bg-blue-700 hover:bg-blue-800">
                <i class="fas fa-home fa-fw mr-3"></i>控制台
            </a>
            <a href="/admin/properties" class="block py-2.5 px-4 rounded transition duration-200 hover:bg-blue-800">
                <i class="fas fa-building fa-fw mr-3"></i>房源管理
            </a>
            <a href="/admin/appointments" class="block py-2.5 px-4 rounded transition duration-200 hover:bg-blue-800">
                <i class="fas fa-calendar-check fa-fw mr-3"></i>预约管理
                <span id="appointmentBadge" class="ml-2 bg-red-500 text-white text-xs px-2 py-1 rounded-full hidden">0</span>
            </a>
            <a href="/admin/customer_favorites" class="block py-2.5 px-4 rounded transition duration-200 hover:bg-blue-800">
                <i class="fas fa-heart fa-fw mr-3"></i>客户收藏
            </a>
            <a href="/admin/locations" class="block py-2.5 px-4 rounded transition duration-200 hover:bg-blue-800">
                <i class="fas fa-map-marker-alt fa-fw mr-3"></i>位置管理
            </a>
            <a href="/admin/property_types" class="block py-2.5 px-4 rounded transition duration-200 hover:bg-blue-800">
                <i class="fas fa-home fa-fw mr-3"></i>房屋类型
            </a>
            <a href="/admin/profile" class="block py-2.5 px-4 rounded transition duration-200 hover:bg-blue-800">
                <i class="fas fa-user fa-fw mr-3"></i>个人资料
            </a>
            <a href="#" class="block py-2.5 px-4 rounded transition duration-200 hover:bg-blue-800">
                <i class="fas fa-chart-line fa-fw mr-3"></i>统计分析
            </a>
            <a href="#" class="block py-2.5 px-4 rounded transition duration-200 hover:bg-blue-800">
                <i class="fas fa-cog fa-fw mr-3"></i>系统设置
            </a>
        </nav>
    </aside>

    <!-- 主要内容区域 -->
    <div class="flex flex-col flex-1 overflow-hidden">
        <!-- 顶部导航栏 -->
        <header class="flex justify-between items-center py-4 px-6 bg-white border-b-4 border-indigo-600 shadow">
            <div class="flex items-center">
                <!-- 移动端菜单按钮 -->
                <button class="text-gray-500 focus:outline-none md:hidden" id="sidebarToggle">
                    <i class="fas fa-bars"></i>
                </button>
                <!-- 搜索框 -->
                <div class="relative mx-4 lg:mx-0">
                    <span class="absolute inset-y-0 left-0 pl-3 flex items-center">
                        <i class="fas fa-search text-gray-500"></i>
                    </span>
                    <input class="form-input w-48 sm:w-64 rounded-md pl-10 pr-4 focus:border-indigo-600" type="text" placeholder="搜索...">
                </div>
            </div>

            <div class="flex items-center">
                <!-- 通知 -->
                <div class="relative">
                    <button class="flex mx-4 text-gray-600 focus:outline-none" title="系统通知">
                        <i class="fas fa-bell text-xl"></i>
                    </button>
                    {% if inactive_properties > 0 %}
                    <div class="absolute top-0 right-0 -mt-1 -mr-1 px-2 py-0.5 rounded-full text-xs bg-red-500 text-white">{{ inactive_properties }}</div>
                    {% endif %}
                </div>
                <!-- 消息 -->
                <div class="relative">
                    <button class="flex mx-4 text-gray-600 focus:outline-none" title="待处理消息">
                        <i class="fas fa-comment text-xl"></i>
                    </button>
                    {% if messages_count > 0 %}
                    <div class="absolute top-0 right-0 -mt-1 -mr-1 px-2 py-0.5 rounded-full text-xs bg-red-500 text-white">{{ messages_count }}</div>
                    {% endif %}
                </div>
                <!-- 用户菜单 -->
                <div class="relative" id="userMenu">
                    <button class="flex items-center text-gray-600 focus:outline-none" onclick="toggleUserMenu()">
                        <div class="h-8 w-8 rounded-full bg-indigo-600 flex items-center justify-center">
                            {% if user.avatar %}
                                <img src="{{ user.avatar }}" alt="头像" class="h-8 w-8 rounded-full object-cover">
                            {% else %}
                                <i class="fas fa-user text-white text-sm"></i>
                            {% endif %}
                        </div>
                        <span class="ml-2 text-sm font-medium hidden md:block">{{ user.display_name or user.username }}</span>
                        <i class="fas fa-chevron-down ml-1 text-sm"></i>
                    </button>

                    <!-- 下拉菜单 -->
                    <div id="userDropdown" class="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-50 hidden">
                        <a href="/admin/profile" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                            <i class="fas fa-user mr-2"></i>个人资料
                        </a>
                        <div class="border-t border-gray-100"></div>
                        <a href="/admin/logout" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                            <i class="fas fa-sign-out-alt mr-2"></i>退出登录
                        </a>
                    </div>
                </div>
            </div>
        </header>

        <!-- 主体内容 -->
        <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100">
            <div class="container mx-auto px-6 py-8">
                <h3 class="text-gray-700 text-3xl font-medium">仪表盘</h3>

                <!-- 统计卡片 -->
                <div class="mt-4">
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                        <!-- 统计卡片 1 -->
                        <div class="bg-white rounded-lg shadow-md p-6 flex items-center">
                            <div class="p-3 rounded-full bg-indigo-600 bg-opacity-75 text-white mr-4">
                                <i class="fas fa-building text-xl"></i>
                            </div>
                            <div>
                                <p class="text-gray-500 text-sm">总房源数</p>
                                <p class="text-2xl font-bold text-gray-800">{{ properties_count }}</p>
                                <p class="text-blue-500 text-xs">
                                    <i class="fas fa-info-circle mr-1"></i>
                                    <span>已上架: {{ active_properties }}</span> <span class="text-gray-500">| 待审核: {{ pending_properties }}</span>
                                </p>
                            </div>
                        </div>
                        <!-- 统计卡片 2 -->
                        <div class="bg-white rounded-lg shadow-md p-6 flex items-center">
                            <div class="p-3 rounded-full bg-green-600 bg-opacity-75 text-white mr-4">
                                <i class="fas fa-users text-xl"></i>
                            </div>
                            <div>
                                <p class="text-gray-500 text-sm">注册用户</p>
                                <p class="text-2xl font-bold text-gray-800">{{ users_count }}</p>
                                <p class="text-green-500 text-xs">
                                    <i class="fas fa-user-check mr-1"></i>
                                    <span>包含管理员</span> <span class="text-gray-500">和普通用户</span>
                                </p>
                            </div>
                        </div>
                        <!-- 统计卡片 3 -->
                        <div class="bg-white rounded-lg shadow-md p-6 flex items-center">
                            <div class="p-3 rounded-full bg-yellow-600 bg-opacity-75 text-white mr-4">
                                <i class="fas fa-clipboard-list text-xl"></i>
                            </div>
                            <div>
                                <p class="text-gray-500 text-sm">活跃房源</p>
                                <p class="text-2xl font-bold text-gray-800">{{ orders_count }}</p>
                                <p class="text-yellow-600 text-xs">
                                    <i class="fas fa-chart-line mr-1"></i>
                                    <span>已上架+待审核</span> <span class="text-gray-500">房源总数</span>
                                </p>
                            </div>
                        </div>
                        <!-- 统计卡片 4 -->
                        <div class="bg-white rounded-lg shadow-md p-6 flex items-center">
                            <div class="p-3 rounded-full bg-red-600 bg-opacity-75 text-white mr-4">
                                <i class="fas fa-exclamation-triangle text-xl"></i>
                            </div>
                            <div>
                                <p class="text-gray-500 text-sm">待处理</p>
                                <p class="text-2xl font-bold text-gray-800">{{ messages_count }}</p>
                                <p class="text-red-500 text-xs">
                                    <i class="fas fa-clock mr-1"></i>
                                    <span>待审核房源</span> <span class="text-gray-500">需要处理</span>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 房源管理 -->
                <h3 class="text-gray-700 text-xl font-medium mt-8">房源管理</h3>
                <div class="flex justify-between items-center mt-4">
                    <div class="flex items-center">
                        <a href="/admin/property/add" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded mr-2 inline-block">
                            <i class="fas fa-plus mr-1"></i> 添加房源
                        </a>
                        <div class="relative mx-2">
                            <select class="appearance-none h-full rounded border block w-full bg-white border-gray-300 text-gray-700 py-2 px-4 pr-8 leading-tight focus:outline-none focus:bg-white focus:border-indigo-500">
                                <option>全部房源</option>
                                <option>加拿大房源</option>
                                <option>中国房源</option>
                            </select>
                            <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                                <i class="fas fa-chevron-down"></i>
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center">
                        <input class="border-2 border-gray-300 bg-white h-10 px-5 pr-10 rounded-lg text-sm focus:outline-none focus:border-indigo-500" type="search" name="search" placeholder="搜索房源">
                        <button class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded ml-2">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>

                <!-- 房源列表 -->
                <div class="mt-6">
                    <div class="bg-white shadow-md rounded my-6 overflow-x-auto">
                        <table class="min-w-full bg-white">
                            <thead class="bg-gray-800 text-white">
                                <tr>
                                    <th class="w-1/12 py-3 px-4 uppercase font-semibold text-sm">ID</th>
                                    <th class="w-2/12 py-3 px-4 uppercase font-semibold text-sm">房源名称</th>
                                    <th class="w-1/12 py-3 px-4 uppercase font-semibold text-sm">地区</th>
                                    <th class="w-1/12 py-3 px-4 uppercase font-semibold text-sm">价格</th>
                                    <th class="w-1/12 py-3 px-4 uppercase font-semibold text-sm">房型</th>
                                    <th class="w-1/12 py-3 px-4 uppercase font-semibold text-sm">面积</th>
                                    <th class="w-2/12 py-3 px-4 uppercase font-semibold text-sm">添加时间</th>
                                    <th class="w-1/12 py-3 px-4 uppercase font-semibold text-sm">状态</th>
                                    <th class="w-2/12 py-3 px-4 uppercase font-semibold text-sm">操作</th>
                                </tr>
                            </thead>
                            <tbody class="text-gray-700">
                                {% for property in recent_properties %}
                                <tr class="border-b hover:bg-gray-50">
                                    <td class="py-3 px-4">#{{ property.id }}</td>
                                    <td class="py-3 px-4">{{ property.name or '未命名' }}</td>
                                    <td class="py-3 px-4">{{ property.location or '-' }}</td>
                                    <td class="py-3 px-4">{{ property.currency or '$' }}{{ property.price or '0' }}/月</td>
                                    <td class="py-3 px-4">{{ property.property_type or '-' }}</td>
                                    <td class="py-3 px-4">{{ property.area or '-' }}m²</td>
                                    <td class="py-3 px-4">{{ property.created_at.strftime('%Y-%m-%d') if property.created_at else '-' }}</td>
                                    <td class="py-3 px-4">
                                        {% if property.status == 'active' %}
                                            <span class="bg-green-200 text-green-700 py-1 px-3 rounded-full text-xs">已上架</span>
                                        {% elif property.status == 'pending' %}
                                            <span class="bg-yellow-200 text-yellow-700 py-1 px-3 rounded-full text-xs">待审核</span>
                                        {% elif property.status == 'inactive' %}
                                            <span class="bg-red-200 text-red-700 py-1 px-3 rounded-full text-xs">已下架</span>
                                        {% else %}
                                            <span class="bg-gray-200 text-gray-700 py-1 px-3 rounded-full text-xs">{{ property.status or '未知' }}</span>
                                        {% endif %}
                                    </td>
                                    <td class="py-3 px-4">
                                        <div class="flex">
                                            <a href="/admin/property/edit/{{ property.id }}" class="bg-blue-500 hover:bg-blue-600 text-white py-1 px-2 rounded mr-2" title="编辑">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                            <a href="/property/{{ property.id }}" target="_blank" class="bg-green-500 hover:bg-green-600 text-white py-1 px-2 rounded mr-2" title="查看">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            <button onclick="toggleStatus({{ property.id }})" class="bg-orange-500 hover:bg-orange-600 text-white py-1 px-2 rounded mr-2" title="切换状态">
                                                <i class="fas fa-toggle-on"></i>
                                            </button>
                                            <button onclick="deleteProperty({{ property.id }})" class="bg-red-500 hover:bg-red-600 text-white py-1 px-2 rounded" title="删除">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="9" class="py-8 px-4 text-center text-gray-500">
                                        <i class="fas fa-home text-4xl mb-4 text-gray-300"></i>
                                        <p>暂无房源数据</p>
                                        <a href="/admin/property/add" class="mt-2 inline-block bg-indigo-600 hover:bg-indigo-700 text-white py-2 px-4 rounded">
                                            <i class="fas fa-plus mr-1"></i>添加第一个房源
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- 分页信息 -->
                <div class="flex justify-between items-center mt-8">
                    <div class="text-gray-500 text-sm">
                        显示最近 {{ recent_properties|length }} 条房源，共 {{ properties_count }} 条
                    </div>
                    <div class="flex items-center space-x-2">
                        <a href="/admin/properties" class="bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2 px-4 rounded">
                            <i class="fas fa-list mr-1"></i>查看全部房源
                        </a>
                        <a href="/admin/property/add" class="bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded">
                            <i class="fas fa-plus mr-1"></i>添加房源
                        </a>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // CSS加载检测和页面显示控制
        function checkDashboardCSSLoaded() {
            return new Promise((resolve) => {
                // 检查TailwindCSS是否加载完成
                const testElement = document.createElement('div');
                testElement.className = 'flex justify-center items-center bg-gray-100';
                testElement.style.position = 'absolute';
                testElement.style.visibility = 'hidden';
                document.body.appendChild(testElement);

                const styles = window.getComputedStyle(testElement);
                const isLoaded = styles.display === 'flex' &&
                                styles.justifyContent === 'center' &&
                                styles.backgroundColor === 'rgb(243, 244, 246)';

                document.body.removeChild(testElement);

                if (isLoaded) {
                    resolve();
                } else {
                    // 每100ms检查一次，最多等待3秒
                    let attempts = 0;
                    const maxAttempts = 30;
                    const checkInterval = setInterval(() => {
                        attempts++;
                        const testEl = document.createElement('div');
                        testEl.className = 'flex bg-gray-100';
                        testEl.style.position = 'absolute';
                        testEl.style.visibility = 'hidden';
                        document.body.appendChild(testEl);

                        const isNowLoaded = window.getComputedStyle(testEl).display === 'flex';
                        document.body.removeChild(testEl);

                        if (isNowLoaded || attempts >= maxAttempts) {
                            clearInterval(checkInterval);
                            resolve();
                        }
                    }, 100);
                }
            });
        }

        // 显示仪表盘页面
        function showDashboardPage() {
            const loader = document.getElementById('dashboardLoader');
            const body = document.body;

            // 添加显示动画类
            body.classList.add('dashboard-loaded');

            // 隐藏加载器
            if (loader) {
                loader.classList.add('hide');
                setTimeout(() => {
                    loader.remove();
                }, 300);
            }
        }

        // 移动端菜单切换
        document.getElementById('sidebarToggle').addEventListener('click', function() {
            const sidebar = document.querySelector('aside');
            sidebar.classList.toggle('-translate-x-full');
        });

        // 房源状态切换功能
        async function toggleStatus(propertyId) {
            if (!confirm('确定要切换房源状态吗？')) return;

            try {
                const response = await fetch(`/admin/property/toggle_status/${propertyId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                if (response.ok) {
                    location.reload(); // 刷新页面显示最新状态
                } else {
                    alert('状态切换失败，请重试');
                }
            } catch (error) {
                console.error('状态切换失败:', error);
                alert('状态切换失败，请重试');
            }
        }

        // 删除房源功能
        async function deleteProperty(propertyId) {
            if (!confirm('确定要删除这个房源吗？此操作不可恢复！')) return;

            try {
                const response = await fetch(`/admin/property/delete/${propertyId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        alert('房源删除成功！');
                        location.reload(); // 刷新页面
                    } else {
                        alert('删除失败：' + (result.message || '未知错误'));
                    }
                } else {
                    alert('删除失败，请重试');
                }
            } catch (error) {
                console.error('删除失败:', error);
                alert('删除失败，请重试');
            }
        }
        document.addEventListener('DOMContentLoaded', async function() {
            // 等待CSS完全加载
            await checkDashboardCSSLoaded();

            // 显示页面
            showDashboardPage();

            // 页面已经包含真实数据，无需额外获取
            console.log('仪表盘页面加载完成，显示真实数据');
        });

        // 用户菜单控制
        function toggleUserMenu() {
            const dropdown = document.getElementById('userDropdown');
            dropdown.classList.toggle('hidden');
        }

        // 点击其他地方关闭用户菜单
        document.addEventListener('click', function(event) {
            const userMenu = document.getElementById('userMenu');
            const dropdown = document.getElementById('userDropdown');

            if (!userMenu.contains(event.target)) {
                dropdown.classList.add('hidden');
            }
        });

        // 更新预约数量徽章
        function updateAppointmentBadge(count) {
            const badge = document.getElementById('appointmentBadge');
            if (count > 0) {
                badge.textContent = count;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }

        // 获取预约数量
        async function loadAppointmentCount() {
            try {
                const response = await fetch('/api/appointments?status=pending');
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        updateAppointmentBadge(data.data.length);
                    }
                }
            } catch (error) {
                console.error('获取预约数量失败:', error);
            }
        }

        // 页面加载完成后立即隐藏加载动画并加载预约数量
        window.addEventListener('DOMContentLoaded', function() {
            // 立即隐藏加载动画，提升用户体验
            document.getElementById('dashboardLoader').style.display = 'none';
            loadAppointmentCount(); // 加载预约数量
        });
    </script>
</body>
</html>