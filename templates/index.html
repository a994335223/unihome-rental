<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UniHome - å›½é™…å­¦ç”Ÿç§Ÿæˆ¿å¹³å°</title>
    <!-- æœ¬åœ°CSSèµ„æºåŠ è½½ -->
    <link href="/static/css/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/all.min.css">
    <link rel="stylesheet" href="/static/css/swiper-bundle.min.css">
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <style>
    /* ç®€åŒ–æ ·å¼ï¼Œç§»é™¤åŠ è½½åŠ¨ç”» */

    :root {
      --main-yellow: #D8B98A;   /* æµ…å¡å…¶é»„ */
      --main-purple: #BCA9C9;   /* æµ…ç´«ç° */
      --main-brown: #6B5B4B;    /* æ·±å’– */
      --main-pink: #E2C6B2;     /* æµ…è‚‰ç²‰ */
      --main-gray: #BDB7A4;     /* ç°ç±³è‰² */
      --main-bluegray: #E3EAF1; /* ææµ…è“ç° */
      --main-milk: #F6F1E7;     /* å¥¶ç™½ */
    }


    /* å¯¼èˆªæ é…è‰² */
    nav.bg-gradient-to-r {
      background: linear-gradient(135deg, #D8B98A 0%, #BCA9C9 100%) !important;
      box-shadow: 0 4px 18px 0 rgba(107,91,75,0.10), 0 1.5px 0 0 #fff2 !important;
      border-bottom: 1.5px solid #e3eaf1;
    }
    nav .text-white, nav .text-indigo-100 {
      color: #fff !important;
      text-shadow: 0 1px 4px rgba(107,91,75,0.10);
    }
    nav .font-bold.text-white {
      color: #fff !important;
      letter-spacing: 1px;
    }
    /* æŒ‰é’®ä¸»è‰² */
    .btn-main, .bg-indigo-500, .bg-indigo-600, .bg-gradient-to-r.from-purple-600.to-indigo-600 {
      background: var(--main-yellow) !important;
      color: var(--main-brown) !important;
      border: none;
    }
    .btn-main:hover, .bg-indigo-600:hover, .bg-indigo-500:hover, .bg-gradient-to-r.from-purple-700.to-indigo-700:hover {
      background: var(--main-brown) !important;
      color: var(--main-milk) !important;
    }
    /* ä¸»æ ‡é¢˜/ä¸»æ–‡å­— */
    .text-gray-900, .font-bold.text-gray-900 {
      color: var(--main-brown) !important;
    }
    /* æ¬¡è¦æ–‡å­— */
    .text-gray-500 {
      color: var(--main-purple) !important;
    }
    /* ç™½è‰²èƒŒæ™¯ç»Ÿä¸€ä¸ºå¥¶ç™½ */
    .bg-white {
      background-color: var(--main-milk) !important;
    }
    /* å¡ç‰‡è¾¹æ¡†/åˆ†å‰²çº¿ */
    .border-gray-200, .border-gray-300 {
      border-color: var(--main-gray) !important;
    }
    /* å…¶ä»–è¾…åŠ©è‰² */
    .bg-gray-100 {
      background-color: var(--main-bluegray) !important;
    }
    .text-white {
      color: var(--main-milk) !important;
    }
    </style>
    <style>
    /* å¡ç‰‡åŒºåŸŸ */
    .shadow-lg, .shadow, .rounded-lg, .overflow-hidden {
      box-shadow: 0 2px 16px 0 rgba(107,91,75,0.08) !important;
      border-radius: 1rem !important;
    }
    .bg-milk, .bg-milk-override, .bg-milk-card, .bg-milk-form {
      background-color: var(--main-milk) !important;
    }
    .bg-pink {
      background-color: var(--main-pink) !important;
    }
    .card-title, .form-title, .footer-title, .text-lg.font-bold.text-gray-900, .text-xl.font-bold.text-gray-900, .text-2xl.font-bold.text-gray-900, .text-3xl.font-bold.text-gray-900 {
      color: var(--main-brown) !important;
    }
    .card-desc, .form-desc, .footer-desc, .text-gray-500, .text-base.text-gray-500 {
      color: var(--main-purple) !important;
    }
    .card-border, .form-border, .footer-border, .border-gray-200, .border-gray-300 {
      border-color: var(--main-gray) !important;
    }
    /* è¡¨å•åŒºåŸŸ */
    input, select, textarea {
      background-color: var(--main-milk) !important;
      border-color: var(--main-gray) !important;
      color: var(--main-brown) !important;
    }
    label, .form-label {
      color: var(--main-brown) !important;
    }
    input::placeholder, textarea::placeholder {
      color: var(--main-purple) !important;
      opacity: 1;
    }
    /* é¡µè„šåŒºåŸŸ */
    footer.bg-gray-900 {
      background: var(--main-brown) !important;
    }
    footer .text-white, footer .text-gray-400, footer .text-gray-300 {
      color: var(--main-milk) !important;
    }
    footer a {
      color: var(--main-milk) !important;
      transition: color 0.2s;
    }
    footer a:hover {
      color: var(--main-yellow) !important;
    }
    footer .border-gray-700 {
      border-color: var(--main-gray) !important;
    }
    /* ä¸»è¦æŒ‰é’®å’Œé«˜äº® */
    .btn-main, .bg-indigo-500, .bg-indigo-600, .bg-gradient-to-r.from-purple-600.to-indigo-600 {
      background: var(--main-yellow) !important;
      color: var(--main-brown) !important;
      border: none;
    }
    .btn-main:hover, .bg-indigo-600:hover, .bg-indigo-500:hover, .bg-gradient-to-r.from-purple-700.to-indigo-700:hover {
      background: var(--main-brown) !important;
      color: var(--main-milk) !important;
    }
    /* ä¸»è¦æ–‡å­— */
    .text-gray-900, .font-bold.text-gray-900, h1, h2, h3, h4, h5, h6 {
      color: var(--main-brown) !important;
    }
    </style>
    <style>
    /* ä¿®å¤å¯¼èˆªæ å››è§’ç™½è‰²éœ²å‡º */
    nav.bg-gradient-to-r {
      border-radius: 0 !important;
      box-shadow: 0 2px 8px 0 rgba(107,91,75,0.08) !important;
    }
    /* é¦–é¡µå¤§å›¾è’™å±‚ä¸»è‰²è°ƒ */
    .hero-main-overlay, .home-hero-overlay, .bg-indigo-800.opacity-60, .bg-indigo-800.opacity-70 {
      background: var(--main-brown) !important;
      opacity: 0.65 !important;
    }
    /* å…¼å®¹åŸæœ‰ç±»åçš„è’™å±‚è¦†ç›– */
    .home-hero-overlay {
      position: absolute;
      inset: 0;
      z-index: 1;
    }
    /* é¦–é¡µä¸»æ ‡é¢˜ç¾åŒ–ï¼šæ·±å’–è‰²+ç™½è‰²æè¾¹+é˜´å½± */
    .home-hero-title {
      color: var(--main-brown) !important;
      text-shadow: 0 2px 12px rgba(255,255,255,0.7), 0 2px 8px rgba(0,0,0,0.18);
      -webkit-text-stroke: 1px #fff;
    }
    /* å‰¯æ ‡é¢˜/æè¿°ï¼šä¸»è‰²æˆ–æ·±å’–è‰²+é˜´å½± */
    .home-hero-subtitle, .home-hero-desc {
      color: var(--main-purple) !important;
      text-shadow: 0 2px 8px rgba(255,255,255,0.18), 0 1px 0 rgba(107,91,75,0.18);
    }
    /* sloganç”¨ä¸»è‰²æˆ–æ·±å’–è‰² */
    .home-hero-slogan {
      color: var(--main-yellow) !important;
      text-shadow: 0 2px 8px rgba(255,255,255,0.12);
    }
    </style>
    <style>
    /* æˆ¿æºå¡ç‰‡ä»·æ ¼å­—ä½“é¢œè‰²ç»Ÿä¸€ */
    .listing-price, .text-indigo-600, .text-indigo-500 {
      color: var(--main-brown) !important;
      font-weight: bold;
      font-size: 1.1em;
    }
    .listing-price:hover, .text-indigo-600:hover, .text-indigo-500:hover {
      color: var(--main-yellow) !important;
    }
    /* ä¸ºä»€ä¹ˆé€‰æ‹©UniHomeå›¾æ ‡é¢œè‰²ç»Ÿä¸€ */
    .feature-icon, .text-indigo-600, .text-indigo-500, .text-blue-600, .text-blue-500 {
      color: var(--main-brown) !important;
      background: none !important;
    }
    .feature-icon-bg {
      background: var(--main-yellow) !important;
      border-radius: 50%;
      padding: 0.5em;
      display: inline-block;
    }
    /* é¡µè„šé‚®ç®±/å›¾æ ‡é¢œè‰²ç»Ÿä¸€ */
    footer .fa-envelope, footer .fa-phone-alt, footer .fa-map-marker-alt, footer .fab {
      color: var(--main-yellow) !important;
    }
    footer .fa-envelope:hover, footer .fa-phone-alt:hover, footer .fa-map-marker-alt:hover, footer .fab:hover {
      color: var(--main-brown) !important;
    }
    footer a[href^="mailto"] {
      color: var(--main-yellow) !important;
    }
    footer a[href^="mailto"]:hover {
      color: var(--main-brown) !important;
    }
    </style>
    <style>
    /* é¦–é¡µå¤§å›¾è’™å±‚æ¸å˜ç¾åŒ–å‡çº§ */
    .home-hero-overlay {
      position: absolute;
      inset: 0;
      z-index: 1;
      background: linear-gradient(120deg, var(--main-yellow) 60%, var(--main-purple) 100%);
      opacity: 0.35 !important;
    }
    /* é¦–é¡µä¸»æ ‡é¢˜ç¾åŒ–ï¼šæ·±å’–è‰²+ç™½è‰²æè¾¹+é˜´å½± */
    .home-hero-title {
      color: var(--main-brown) !important;
      text-shadow: 0 2px 12px rgba(255,255,255,0.7), 0 2px 8px rgba(0,0,0,0.18);
      -webkit-text-stroke: 1px #fff;
    }

    /* Font Awesome å›¾æ ‡å¤‡ç”¨æ ·å¼ */
    .fa-globe::before { content: "ğŸŒ"; }
    .fa-heart::before { content: "â¤ï¸"; }
    .fa-user-circle::before { content: "ğŸ‘¤"; }
    .fa-home::before { content: "ğŸ "; }
    .fa-chevron-left::before { content: "â€¹"; }
    .fa-chevron-right::before { content: "â€º"; }
    .fa-video::before { content: "ğŸ“¹"; }
    .fa-envelope::before { content: "âœ‰ï¸"; }
    .fa-phone-alt::before { content: "ğŸ“"; }
    .fa-map-marker-alt::before { content: "ğŸ“"; }
    .fa-weixin::before {
        content: "W";
        background: #07C160;
        color: white;
        border-radius: 3px;
        padding: 2px 4px;
        font-weight: bold;
        font-size: 0.8em;
    }
    /* å‰¯æ ‡é¢˜/æè¿°ï¼šç™½è‰²+é˜´å½± */
    .home-hero-subtitle, .home-hero-desc {
      color: #fff !important;
      text-shadow: 0 2px 8px rgba(0,0,0,0.18), 0 1px 0 rgba(107,91,75,0.18);
    }
    /* sloganç”¨ä¸»è‰²æˆ–ç™½è‰² */
    .home-hero-slogan {
      color: var(--main-yellow) !important;
      text-shadow: 0 2px 8px rgba(0,0,0,0.12);
    }
    </style>
    <style>
    /* è¯¦æƒ…é¡µæŒ‰é’®ç¾åŒ– */
    .detail-btn-outline {
      border: 2px solid var(--main-brown) !important;
      color: var(--main-brown) !important;
      background: transparent !important;
      transition: all 0.2s;
    }
    .detail-btn-outline:hover {
      border-color: var(--main-yellow) !important;
      color: var(--main-yellow) !important;
      background: rgba(216,185,138,0.08) !important;
    }
    .detail-btn-main, .whatsapp-btn {
      background: var(--main-yellow) !important;
      color: var(--main-brown) !important;
      border: none !important;
      transition: all 0.2s;
    }
    .detail-btn-main:hover, .whatsapp-btn:hover {
      background: var(--main-brown) !important;
      color: var(--main-milk) !important;
    }
    </style>
</head>
<body class="bg-gray-50 font-sans">
    <!-- å¯¼èˆªæ  -->
    <nav class="bg-gradient-to-r from-purple-600 to-indigo-700 shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <div class="flex-shrink-0 flex items-center">
                        <img class="h-10 w-10 rounded-full mr-2" style="object-fit:cover;" src="static/images/icon_lg.png" alt="UniHome Logo">
                        <span class="text-white text-xl font-bold">UniHome</span>
                    </div>
                    <div class="hidden md:ml-6 md:flex md:space-x-8">
                        <a href="#" class="text-white hover:text-indigo-100 px-3 py-2 rounded-md text-sm font-medium">é¦–é¡µ</a>
                        <!-- <a href="#" class="text-indigo-100 hover:text-white px-3 py-2 rounded-md text-sm font-medium">åŠ æ‹¿å¤§æˆ¿æº</a> -->
                        <!-- <a href="#" class="text-indigo-100 hover:text-white px-3 py-2 rounded-md text-sm font-medium">ä¸­å›½æˆ¿æº</a> -->
                        <a href="about.html" class="text-indigo-100 hover:text-white px-3 py-2 rounded-md text-sm font-medium">å…³äºæˆ‘ä»¬</a>
                    </div>
                </div>
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <button class="relative inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-500 shadow-sm hover:bg-indigo-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            <i class="fas fa-user-circle mr-2"></i>
                            <span>ç™»å½•/æ³¨å†Œ</span>
                        </button>
                    </div>
                    <div class="hidden md:ml-4 md:flex-shrink-0 md:flex md:items-center md:space-x-2">
                        <button class="bg-indigo-600 hover:bg-indigo-700 w-10 h-10 rounded-full text-white focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-200 flex items-center justify-center">
                            <span class="sr-only">åˆ‡æ¢è¯­è¨€</span>
                            <i class="fas fa-globe text-xl"></i>
                        </button>
                        <a href="/favorites" class="bg-indigo-600 hover:bg-indigo-700 w-10 h-10 rounded-full text-white focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-200 flex items-center justify-center" title="æˆ‘çš„æ”¶è—">
                            <span class="sr-only">æˆ‘çš„æ”¶è—</span>
                            <i class="fas fa-heart text-xl"></i>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- è‹±é›„åŒºåŸŸï¼ˆé¦–é¡µï¼‰ -->
    <div id="home-section">
        <div class="relative bg-indigo-800">
            <div class="absolute inset-0">
                <img class="w-full h-full object-cover" src="/static/images/hero_bg.jpg" alt="å­¦ç”Ÿå…¬å¯“">
                <!-- è’™å±‚å½»åº•ç§»é™¤ï¼Œä¿è¯èƒŒæ™¯å›¾é€šé€ -->
            </div>
            <div class="relative max-w-7xl mx-auto py-20 px-4 sm:py-28 sm:px-6 lg:px-8 flex flex-col items-center justify-center" style="min-height: 420px;">
                <!-- ä¸Šæ–¹å¤§æ ‡é¢˜ -->
                <h1 class="text-4xl sm:text-5xl lg:text-6xl font-extrabold tracking-tight text-white text-center mb-6 home-hero-title" style="letter-spacing: 2px;">åŒ—ç¾ç•™å­¦ç”Ÿå¯„å®¿å®¶åº­è”ç›Ÿ</h1>
                <!-- å€’æ¢¯å½¢æè¿°åŒº -->
                <div class="w-full flex flex-col items-center">
                    <div class="bg-white bg-opacity-10 rounded-lg px-4 py-2 mb-2" style="max-width: 600px;">
                        <p class="text-2xl sm:text-3xl text-white text-center font-semibold leading-tight mb-1 home-hero-subtitle" style="letter-spacing: 1px;">North America Homestay Alliance</p>
                    </div>
                    <div class="w-full flex flex-col items-center" style="max-width: 600px;">
                        <div class="w-full flex flex-col items-center" style="clip-path: polygon(10% 0, 90% 0, 100% 100%, 0% 100%); background: rgba(255,255,255,0.08);">
                            <p class="text-lg sm:text-3xl text-white text-center font-normal px-4 pt-2 pb-1 home-hero-desc" style="letter-spacing: 1px;">æˆ‘ä»¬è‡´åŠ›äºå¸®åŠ©åŠ æ‹¿å¤§ä¸»è¦åŸå¸‚</p>
                            <p class="text-lg sm:text-2xl text-white text-center font-normal px-4 pt-2 pb-1 home-hero-desc" style="letter-spacing: 1px;">å®‰æ’ç•™å­¦ç”Ÿå¯„å®¿å®¶åº­èµ„æºå¯¹æ¥</p>
                        </div>
                    </div>
                </div>
                <!-- åº•éƒ¨ç‹¬ç«‹æè¿° -->
                <div class="mt-8 flex flex-col items-center">
                    <div class="flex flex-row space-x-8 bg-white bg-opacity-20 rounded-lg px-8 py-2">
                        <span class="text-xl sm:text-2xl text-white font-bold tracking-wider home-hero-slogan">Better Stay</span>
                        <span class="text-xl sm:text-2xl text-white font-bold tracking-wider home-hero-slogan">Better Future</span>
                    </div>
                </div>
            </div>
        </div>
        <!-- æœç´¢åŒºåŸŸ -->
        <div class="relative -mt-12 max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="bg-white shadow-xl rounded-lg overflow-hidden">
                <div class="px-4 py-5 sm:p-6">
                    <h3 class="text-lg leading-6 font-medium text-gray-900">æ‰¾åˆ°æ‚¨ç†æƒ³çš„ä½æ‰€</h3>
                    <div class="mt-5 grid grid-cols-1 gap-4 sm:grid-cols-5">
                        <div>
                            <label for="location" class="block text-sm font-medium text-gray-700">ä½ç½®</label>
                            <select id="location" name="location" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                                <option value="">å…¨éƒ¨</option>
                                <!-- åŠ¨æ€åŠ è½½ä½ç½®é€‰é¡¹ -->
                            </select>
                        </div>
                        <div>
                            <label for="price" class="block text-sm font-medium text-gray-700">ä»·æ ¼èŒƒå›´</label>
                            <select id="price" name="price" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                                <option value="">å…¨éƒ¨</option>
                                <!-- åŠ¨æ€åŠ è½½ä»·æ ¼åŒºé—´é€‰é¡¹ -->
                            </select>
                        </div>
                        <div>
                            <label for="type" class="block text-sm font-medium text-gray-700">æˆ¿å±‹ç±»å‹</label>
                            <select id="type" name="type" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                                <option value="">å…¨éƒ¨</option>
                                <!-- åŠ¨æ€åŠ è½½æˆ¿å±‹ç±»å‹é€‰é¡¹ -->
                            </select>
                        </div>
                        <div>
                            <label for="sortBy" class="block text-sm font-medium text-gray-700">æ’åºæ–¹å¼</label>
                            <select id="sortBy" name="sortBy" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                                <option value="created_at_desc">æœ€æ–°å‘å¸ƒ</option>
                                <option value="price_asc">ä»·æ ¼ä»ä½åˆ°é«˜</option>
                                <option value="price_desc">ä»·æ ¼ä»é«˜åˆ°ä½</option>
                                <option value="name_asc">åç§°A-Z</option>
                                <option value="name_desc">åç§°Z-A</option>
                            </select>
                        </div>
                        <div class="flex items-end space-x-2">
                            <button type="button" id="searchBtn" class="flex-1 inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                <i class="fas fa-search mr-2"></i> æœç´¢
                            </button>
                            <button type="button" id="resetBtn" class="inline-flex items-center justify-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md shadow-sm text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                <i class="fas fa-undo mr-2"></i> é‡ç½®
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- æœç´¢ç»“æœåŒºåŸŸ -->
        <section class="py-12 bg-gray-50" id="searchResults" style="display: none;">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="text-center mb-8">
                    <h2 class="text-3xl font-extrabold text-gray-900">æœç´¢ç»“æœ</h2>
                    <p class="mt-4 text-lg text-gray-600" id="resultCount">æ‰¾åˆ° 0 ä¸ªæˆ¿æº</p>
                </div>

                <!-- åŠ è½½çŠ¶æ€ -->
                <div id="loadingSpinner" class="text-center py-12" style="display: none;">
                    <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600"></div>
                    <p class="mt-4 text-gray-600">æ­£åœ¨æœç´¢æˆ¿æº...</p>
                </div>

                <!-- æˆ¿æºåˆ—è¡¨ -->
                <div id="propertyList" class="grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-3">
                    <!-- åŠ¨æ€åŠ è½½æˆ¿æºå¡ç‰‡ -->
                </div>

                <!-- æ— ç»“æœæç¤º -->
                <div id="noResults" class="text-center py-12" style="display: none;">
                    <div class="text-gray-400 mb-4">
                        <i class="fas fa-search text-6xl"></i>
                    </div>
                    <h3 class="text-xl font-medium text-gray-900 mb-2">æœªæ‰¾åˆ°åŒ¹é…çš„æˆ¿æº</h3>
                    <p class="text-gray-600">è¯·å°è¯•è°ƒæ•´æœç´¢æ¡ä»¶æˆ–æµè§ˆæ‰€æœ‰æˆ¿æº</p>
                    <button type="button" id="clearFilters" class="mt-4 inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-indigo-600 bg-indigo-100 hover:bg-indigo-200">
                        <i class="fas fa-times mr-2"></i>æ¸…é™¤ç­›é€‰æ¡ä»¶
                    </button>
                </div>

                <!-- åˆ†é¡µ -->
                <div id="pagination" class="mt-8 flex justify-center" style="display: none;">
                    <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
                        <!-- åŠ¨æ€ç”Ÿæˆåˆ†é¡µæŒ‰é’® -->
                    </nav>
                </div>
            </div>
        </section>

        <!-- æˆ¿æºåˆ—è¡¨ -->
        <div class="max-w-7xl mx-auto py-12 px-4 sm:px-6 lg:px-8" id="defaultPropertyList">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-900">ç²¾é€‰æˆ¿æº</h2>
              
            </div>

            <div id="listing-cards" class="grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-3"></div>
            <!-- åˆ†é¡µ -->
            <div id="pagination-container" class="mt-12 flex justify-center">
                <!-- åˆ†é¡µå†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>

        <!-- ç‰¹ç‚¹ä»‹ç» -->
        <div class="bg-gray-100 py-12">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="text-center">
                    <h2 class="text-3xl font-extrabold text-gray-900 sm:text-4xl">ä¸ºä»€ä¹ˆé€‰æ‹© UniHome?</h2>
                    <p class="mt-4 max-w-2xl mx-auto text-xl text-gray-500">æˆ‘ä»¬ä¸ºç•™å­¦ç”Ÿæä¾›å®‰å…¨ã€èˆ’é€‚çš„ä½å®¿é€‰æ‹©ï¼Œè®©æ‚¨ä¸“æ³¨äºå­¦ä¸šå’Œç”Ÿæ´»ã€‚</p>
                </div>

                <div class="mt-12">
                    <div class="grid grid-cols-1 gap-8 sm:grid-cols-2 lg:grid-cols-3">
                        <div class="bg-white p-6 rounded-lg shadow-md transition-all duration-300 hover:shadow-xl">
                            <div class="text-indigo-600 mb-4">
                                <i class="fas fa-shield-alt text-4xl feature-icon"></i>
                            </div>
                            <h3 class="text-xl font-bold text-gray-900">å®‰å…¨å¯é </h3>
                            <p class="mt-2 text-base text-gray-500">æ‰€æœ‰æˆ¿æºç»è¿‡ä¸¥æ ¼ç­›é€‰å’Œå®åœ°è€ƒå¯Ÿï¼Œç¡®ä¿æ‚¨çš„ä½å®¿å®‰å…¨æ— å¿§ã€‚</p>
                        </div>

                        <div class="bg-white p-6 rounded-lg shadow-md transition-all duration-300 hover:shadow-xl">
                            <div class="text-indigo-600 mb-4">
                                <i class="fas fa-globe-americas text-4xl feature-icon"></i>
                            </div>
                            <h3 class="text-xl font-bold text-gray-900">è·¨å›½æœåŠ¡</h3>
                            <p class="mt-2 text-base text-gray-500">æ— è®ºæ‚¨åœ¨åŠ æ‹¿å¤§è¿˜æ˜¯ä¸­å›½ç•™å­¦ï¼Œæˆ‘ä»¬éƒ½èƒ½ä¸ºæ‚¨æä¾›ä¸“ä¸šçš„ç§Ÿæˆ¿æœåŠ¡ã€‚</p>
                        </div>

                        <div class="bg-white p-6 rounded-lg shadow-md transition-all duration-300 hover:shadow-xl">
                            <div class="text-indigo-600 mb-4">
                                <i class="fas fa-comments text-4xl feature-icon"></i>
                            </div>
                            <h3 class="text-xl font-bold text-gray-900">å¤šè¯­è¨€æ”¯æŒ</h3>
                            <p class="mt-2 text-base text-gray-500">æˆ‘ä»¬çš„å›¢é˜Ÿæä¾›ä¸­è‹±åŒè¯­æœåŠ¡ï¼Œè§£å†³æ‚¨çš„æ‰€æœ‰ç–‘é—®å’Œéœ€æ±‚ã€‚</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- å…³äºæˆ‘ä»¬é¡µé¢å†…å®¹ï¼Œé»˜è®¤éšè— -->
    <div id="about-section" style="display:none;">
        <div class="relative bg-indigo-800">
            <div class="absolute inset-0">
                <img class="w-full h-full object-cover" src="https://images.unsplash.com/photo-1560448204-e02f11c3d0e2?ixlib=rb-1.2.1&auto=format&fit=crop&w=1950&q=80" alt="å­¦ç”Ÿå…¬å¯“">
                <!-- è’™å±‚å½»åº•ç§»é™¤ï¼Œä¿è¯èƒŒæ™¯å›¾é€šé€ -->
            </div>
            <div class="relative max-w-4xl mx-auto py-20 px-4 sm:py-28 sm:px-6 lg:px-8 flex flex-col items-center justify-center" style="min-height: 320px;">
                <h1 class="text-4xl sm:text-5xl font-extrabold tracking-tight text-white text-center mb-4">å…³äºæˆ‘ä»¬</h1>
                <p class="text-xl text-white text-center max-w-2xl font-bold">åŒ—ç¾ç•™å­¦ç”Ÿå¯„å®¿å®¶åº­è”ç›Ÿâ€”â€”æ‚¨å€¼å¾—ä¿¡èµ–çš„ç•™å­¦å¯„å®¿ä¼™ä¼´</p>
            </div>
        </div>
        <main class="max-w-4xl mx-auto px-4 py-12">
            <section class="bg-white rounded-lg shadow-lg p-8">
                <h2 class="text-2xl font-bold text-indigo-700 mb-4">æœºæ„ç®€ä»‹</h2>
                <p class="text-gray-700 mb-4">ä½œä¸ºåœ¨åŠ æ‹¿å¤§æ”¿åºœæ³¨å†Œçš„ä¸“ä¸šç•™å­¦å¯„å®¿æœåŠ¡æœºæ„ï¼Œæ€»éƒ¨åè½äºé£æ™¯ç§€ä¸½çš„æ¸©å“¥åï¼Œæˆ‘ä»¬å§‹ç»ˆè‡´åŠ›äºä¸ºå›½é™…ç•™å­¦ç”Ÿæ‰“é€ å®‰å…¨ã€æ¸©é¦¨ã€å……æ»¡æ–‡åŒ–å…³æ€€çš„å¯„å®¿ç¯å¢ƒã€‚æˆ‘ä»¬ä¸ä»…æ˜¯å¯„å®¿æœåŠ¡çš„æä¾›è€…ï¼Œæ›´æ˜¯è·¨æ–‡åŒ–æ¡¥æ¢çš„æ­å»ºè€…ï¼Œé€šè¿‡ä¸¥æ ¼çš„å®¶åº­ç­›é€‰æœºåˆ¶å’Œé«˜æ•ˆçš„æ²Ÿé€šå¹³å°ï¼Œä¿ƒè¿›ç•™å­¦ç”Ÿä¸å¯„å®¿å®¶åº­é—´çš„æ·±åº¦ç†è§£ä¸é•¿æœŸèåˆã€‚</p>
                <h2 class="text-2xl font-bold text-indigo-700 mb-4 mt-8">æˆ‘ä»¬çš„æ ¸å¿ƒæ‰¿è¯º</h2>
                <ul class="list-disc pl-6 space-y-2 text-gray-700">
                    <li><span class="font-semibold" style="color: var(--main-brown);">é«˜æ ‡å‡†å¯„å®¿å®¶åº­ï¼š</span>æ‰€æœ‰åˆä½œå¯„å®¿å®¶åº­å‡é€šè¿‡æˆ‘ä»¬å®åœ°è€ƒå¯Ÿä¸“ä¸šå®¡æ ¸åŠå®¶åº­èƒŒæ™¯è°ƒæŸ¥ï¼Œå¹¶æŒç»­æ¥å—è¡Œä¸šè§„èŒƒåŸ¹è®­ï¼Œç¡®ä¿å¯„å®¿å®¶åº­å…·æœ‰åˆæ³•èµ„è´¨ï¼Œç¬¦åˆå®‰å…¨ã€è´£ä»»ä¸æ–‡åŒ–åŒ…å®¹æ€§è¦æ±‚ã€‚</li>
                    <li><span class="font-semibold" style="color: var(--main-brown);">æ–‡åŒ–æ²‰æµ¸ä½“éªŒï¼š</span>ç²¾å¿ƒåŒ¹é…é€‚åˆå­¦ç”ŸèƒŒæ™¯çš„å¯„å®¿å®¶åº­ï¼Œæä¾›å‚ä¸ç¤¾åŒºæ´»åŠ¨ã€åˆ›é€ æ›´å¤šäº¤æµæœºä¼šï¼Œå…±åŒæ‰“é€ ä¸°å¯Œè€Œæœ‰æ„ä¹‰çš„å¯„å®¿ä½“éªŒã€‚</li>
                    <li><span class="font-semibold" style="color: var(--main-brown);">å­¦ä¸šæ”¯æŒä½“ç³»ï¼š</span>ä»é€‚å®œçš„å­¦ä¹ ç©ºé—´åˆ°æœ¬åœ°æ•™è‚²èµ„æºå…±äº«ï¼Œæˆ‘ä»¬å…¨æ–¹ä½å®ˆæŠ¤ç•™å­¦ç”Ÿçš„å­¦ä¸šæˆé•¿ï¼Œä¸ºä»–ä»¬åœ¨å¼‚å›½ä»–ä¹¡çš„æ±‚å­¦ç”Ÿæ´»å¥ å®šåšå®åŸºç¡€ã€‚</li>
                    <li><span class="font-semibold" style="color: var(--main-brown);">24å°æ—¶ç´§æ€¥å“åº”ï¼š</span>ä¸“ä¸šå›¢é˜Ÿéšæ—¶è§£å†³ä½å®¿ç›¸å…³é—®é¢˜ï¼Œç¡®ä¿ç•™å­¦ç”Ÿä¸“æ³¨å­¦ä¸šï¼Œè®©å­¦ç”Ÿä¸å®¶é•¿æ— åé¡¾ä¹‹å¿§ï¼ŒååŠ©æ‚¨ä¸ºç•™å­¦ç”Ÿæä¾›å“è¶Šè´´å¿ƒçš„å¯„å®¿æœåŠ¡ã€‚</li>
                </ul>
                <h2 class="text-2xl font-bold text-indigo-700 mb-4 mt-8">æˆ‘ä»¬çš„ä»·å€¼</h2>
                <p class="text-gray-700 mb-4">æˆ‘ä»¬ç›¸ä¿¡ï¼Œä¼˜ç§€çš„å¯„å®¿ä½“éªŒæ˜¯ç•™å­¦æˆåŠŸçš„åŸºçŸ³ã€‚é€šè¿‡<span style="color: var(--main-brown); font-weight: bold;">"å­¦ä¸š+å¯„å®¿+æ–‡åŒ–"</span>çš„ä¸‰ç»´æ¨¡å¼ï¼Œæˆ‘ä»¬å·²å¸®åŠ©æ•°ç™¾åç•™å­¦ç”Ÿè·å¾—ï¼š</p>
                <ul class="list-disc pl-6 space-y-2 text-gray-700">
                    <li>æ›´æ¸©é¦¨çš„å¯„å®¿ç¯å¢ƒ</li>
                    <li>æ›´å¹¿é˜”çš„äººé™…ç½‘ç»œ</li>
                    <li>æ›´æ·±åˆ»çš„è·¨æ–‡åŒ–è®¤çŸ¥</li>
                </ul>
                <p class="text-gray-700 mt-6">è®©æ¯ä¸€ä¸ªå¼‚å›½æ±‚å­¦çš„å­¦ç”Ÿï¼Œæ„Ÿå—åˆ°å®¶çš„æ¸©åº¦ä¸æˆé•¿çš„åŠ¨åŠ›æ˜¯æœ¬å…¬å¸æœåŠ¡å®—æ—¨å’Œä¼ä¸šç†å¿µã€‚</p>
            </section>
        </main>
    </div>

    <!-- è¯¦æƒ…é¡µé¢å†…å®¹ï¼Œé»˜è®¤éšè— -->
    <div id="detail-section" style="display:none;"></div>

    <!-- é¡µè„š -->
    <footer class="bg-gray-900 text-white">
        <div class="max-w-7xl mx-auto py-12 px-4 sm:px-6 lg:px-8">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
                <div>
                    <div class="flex items-center">
                        <img class="h-10 w-10 rounded-full mr-2" style="object-fit:cover;" src="static/images/icon_lg.png" alt="UniHome Logo">
                        <span class="text-white text-xl font-bold">UniHome</span>
                    </div>
                    <p class="mt-2 text-sm text-gray-400">ä¸ºå›½é™…å­¦ç”Ÿæä¾›ä¼˜è´¨çš„ç§Ÿæˆ¿æœåŠ¡ï¼Œè®©æ‚¨çš„ç•™å­¦ç”Ÿæ´»æ›´åŠ ä¾¿æ·ã€‚</p>
                    
                </div>
                <div>
                    <h3 class="text-sm font-semibold text-gray-300 tracking-wider uppercase">å¿«é€Ÿé“¾æ¥</h3>
                    <ul class="mt-4 space-y-4">
                        <li><a href="about.html" class="text-base text-gray-400 hover:text-white">å…³äºæˆ‘ä»¬</a></li>
                        <li><a href="#" class="text-base text-gray-400 hover:text-white">å¸¸è§é—®é¢˜</a></li>
                        <li><a href="#" class="text-base text-gray-400 hover:text-white">è”ç³»æˆ‘ä»¬</a></li>
                        <li><a href="#" class="text-base text-gray-400 hover:text-white">éšç§æ”¿ç­–</a></li>
                    </ul>
                </div>
                <div>
                    <h3 class="text-sm font-semibold text-gray-300 tracking-wider uppercase">æˆ¿æºåˆ†ç±»</h3>
                    <ul class="mt-4 space-y-4">
                        <!-- <li><a href="#" class="text-base text-gray-400 hover:text-white">åŠ æ‹¿å¤§æˆ¿æº</a></li> -->
                        <!-- <li><a href="#" class="text-base text-gray-400 hover:text-white">ä¸­å›½æˆ¿æº</a></li> -->
                        <li><a href="#" class="text-base text-gray-400 hover:text-white">å­¦ç”Ÿå®¿èˆ</a></li>
                        <li><a href="#" class="text-base text-gray-400 hover:text-white">åˆç§Ÿå…¬å¯“</a></li>
                    </ul>
                </div>
                <div>
                    <h3 class="text-sm font-semibold text-gray-300 tracking-wider uppercase">è”ç³»æˆ‘ä»¬</h3>
                    <ul class="mt-4 space-y-4" id="footerContact">
                        <li class="flex">
                            <i class="fas fa-map-marker-alt mt-1 mr-2 text-indigo-400"></i>
                            <span class="text-gray-400" id="footerAddress">åŠ è½½ä¸­...</span>
                        </li>
                        <li class="flex">
                            <i class="fas fa-phone-alt mt-1 mr-2 text-indigo-400"></i>
                            <span class="text-gray-400" id="footerPhone">åŠ è½½ä¸­...</span>
                        </li>
                        <li class="flex">
                            <i class="fas fa-envelope mt-1 mr-2 text-indigo-400"></i>
                            <span class="text-gray-400" id="footerEmail">åŠ è½½ä¸­...</span>
                        </li>
                    </ul>
                </div>
            </div>
            <div class="mt-8 border-t border-gray-700 pt-8 md:flex md:items-center md:justify-between">
                <div class="flex space-x-6 md:order-2">
                    <a href="#" class="text-gray-400 hover:text-white">æ¡æ¬¾</a>
                    <a href="#" class="text-gray-400 hover:text-white">éšç§</a>
                    <a href="#" class="text-gray-400 hover:text-white">Cookies</a>
                </div>
                <p class="mt-8 text-base text-gray-400 md:mt-0 md:order-1">Â© 2023 UniHome. ä¿ç•™æ‰€æœ‰æƒåˆ©ã€‚</p>
            </div>
        </div>
    </footer>

    <!-- ç™»å½•/æ³¨å†Œå¼¹çª— -->
    <div id="auth-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-40" style="display:none;">
      <div class="bg-white rounded-lg shadow-lg w-full max-w-md p-8 relative">
        <button id="auth-modal-close" class="absolute top-2 right-2 text-gray-400 hover:text-gray-700 text-2xl">&times;</button>
        <div id="auth-tabs" class="flex mb-6 border-b">
          <button id="show-login" class="flex-1 py-2 text-center font-bold border-b-2 border-transparent focus:outline-none">ç™»å½•</button>
          <button id="show-register" class="flex-1 py-2 text-center font-bold border-b-2 border-transparent focus:outline-none">æ³¨å†Œ</button>
        </div>
        <!-- ç™»å½•è¡¨å• -->
        <form id="login-form" style="display:block;">
          <div class="mb-4">
            <label class="block text-gray-700 mb-1">é‚®ç®±</label>
            <input type="email" name="email" class="w-full px-3 py-2 border rounded focus:outline-none" required>
          </div>
          <div class="mb-4">
            <label class="block text-gray-700 mb-1">å¯†ç </label>
            <input type="password" name="password" class="w-full px-3 py-2 border rounded focus:outline-none" required>
          </div>
          <div class="mb-4 text-right">
            <a href="#" class="text-sm text-indigo-600 hover:underline">å¿˜è®°å¯†ç ï¼Ÿ</a>
          </div>
          <button type="submit" class="w-full btn-main py-2 rounded font-bold">ç™»å½•</button>
        </form>
        <!-- æ³¨å†Œè¡¨å• -->
        <form id="register-form" style="display:none;">
          <div class="mb-4">
            <label class="block text-gray-700 mb-1">é‚®ç®±</label>
            <input type="email" name="email" class="w-full px-3 py-2 border rounded focus:outline-none" required>
          </div>
          <div class="mb-4 flex items-start space-x-2">
            <div class="flex-1">
              <label class="block text-gray-700 mb-1">éªŒè¯ç </label>
              <input type="text" name="code" class="w-full px-3 py-2 border rounded focus:outline-none" required>
            </div>
            <div class="flex items-end h-full pt-6">
              <button type="button" id="send-code-btn" class="btn-main px-3 py-2 rounded w-full">å‘é€éªŒè¯ç </button>
            </div>
          </div>
          <div class="mb-4">
            <label class="block text-gray-700 mb-1">è®¾ç½®å¯†ç </label>
            <input type="password" name="password" class="w-full px-3 py-2 border rounded focus:outline-none" required>
          </div>
          <button type="submit" class="w-full btn-main py-2 rounded font-bold">æ³¨å†Œ</button>
        </form>
        <div id="auth-msg" class="mt-4 text-center text-sm text-red-500"></div>
      </div>
    </div>

    <script>
    // Swiperå®ä¾‹å…¨å±€å˜é‡
    let swiperInstance = null;

    // åŠ¨æ€è·å–æˆ¿æºæ•°æ®å¹¶æ¸²æŸ“
    let listings = [];
    let currentPage = 1;
    const itemsPerPage = 6;

    function renderListings(page = 1) {
        const container = document.getElementById('listing-cards');
        if (!container) return;

        // è®¡ç®—åˆ†é¡µ
        const startIndex = (page - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        const currentListings = listings.slice(startIndex, endIndex);

        // æ¸²æŸ“æˆ¿æºå¡ç‰‡
        container.innerHTML = currentListings.map((listing, idx) => `
            <div class="bg-white overflow-hidden shadow-lg rounded-lg transition-transform duration-300 hover:transform hover:scale-105">
                <div class="relative">
                    <img class="h-80 w-full object-cover rounded-lg" src="${listing.images && listing.images[0] ? listing.images[0] : '/static/images/icon_lg.png'}" alt="å…¬å¯“å†…éƒ¨">
                    <div class="absolute top-0 right-0 m-2 px-2 py-1 bg-indigo-500 text-white text-xs rounded">${listing.location || ''}</div>
                </div>
                <div class="p-4">
                    <div class="flex justify-between items-center">
                        <h3 class="text-lg font-bold text-gray-900 truncate">${listing.name}</h3>
                        <p class="text-lg font-bold text-indigo-600">${listing.price ? (listing.currency || '') + listing.price + '/æœˆ' : ''}</p>
                    </div>
                    <p class="mt-1 text-sm text-gray-500"><i class="fas fa-map-marker-alt text-red-500 mr-1"></i> ${listing.location || ''}</p>
                    <div class="mt-3 flex justify-between text-sm text-gray-500">
                        <div><i class="fas fa-bed mr-1"></i> ${listing.bedrooms || 1}åºŠ</div>
                        <div><i class="fas fa-bath mr-1"></i> ${listing.bathrooms || 1}æµ´</div>
                        <div><i class="fas fa-vector-square mr-1"></i> ${listing.area || 20}mÂ²</div>
                    </div>
                    <div class="mt-4">
                        <a href="#" class="block w-full text-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700" data-listing-id="${listing.id}">æŸ¥çœ‹è¯¦æƒ…</a>
                    </div>
                </div>
            </div>
        `).join('');

        // ç»‘å®šè¯¦æƒ…é¡µé¢äº‹ä»¶
        container.querySelectorAll('a[data-listing-id]').forEach(function(el) {
            el.addEventListener('click', function(e) {
                e.preventDefault();
                const listingId = parseInt(this.getAttribute('data-listing-id'));
                showSection('detail', true, listingId);
                window.scrollTo(0,0);
            });
        });

        // æ¸²æŸ“åˆ†é¡µ
        renderPagination(page);
    }

    function renderPagination(currentPage) {
        const container = document.getElementById('pagination-container');
        if (!container) return;

        const totalPages = Math.ceil(listings.length / itemsPerPage);

        // å¦‚æœåªæœ‰ä¸€é¡µæˆ–æ²¡æœ‰æ•°æ®ï¼Œä¸æ˜¾ç¤ºåˆ†é¡µ
        if (totalPages <= 1) {
            container.innerHTML = '';
            return;
        }

        let paginationHTML = `
            <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
        `;

        // ä¸Šä¸€é¡µæŒ‰é’®
        const prevDisabled = currentPage === 1;
        paginationHTML += `
            <a href="#" class="pagination-btn relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium ${prevDisabled ? 'text-gray-300 cursor-not-allowed' : 'text-gray-500 hover:bg-gray-50'}" data-page="${currentPage - 1}" ${prevDisabled ? 'disabled' : ''}>
                <span class="sr-only">ä¸Šä¸€é¡µ</span>
                <i class="fas fa-chevron-left"></i>
            </a>
        `;

        // é¡µç æŒ‰é’®
        for (let i = 1; i <= totalPages; i++) {
            const isActive = i === currentPage;
            paginationHTML += `
                <a href="#" class="pagination-btn relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium ${isActive ? 'bg-indigo-50 text-indigo-600 hover:bg-indigo-100' : 'bg-white text-gray-500 hover:bg-gray-50'}" data-page="${i}">
                    ${i}
                </a>
            `;
        }

        // ä¸‹ä¸€é¡µæŒ‰é’®
        const nextDisabled = currentPage === totalPages;
        paginationHTML += `
            <a href="#" class="pagination-btn relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium ${nextDisabled ? 'text-gray-300 cursor-not-allowed' : 'text-gray-500 hover:bg-gray-50'}" data-page="${currentPage + 1}" ${nextDisabled ? 'disabled' : ''}>
                <span class="sr-only">ä¸‹ä¸€é¡µ</span>
                <i class="fas fa-chevron-right"></i>
            </a>
        `;

        paginationHTML += `</nav>`;

        container.innerHTML = paginationHTML;

        // ç»‘å®šåˆ†é¡µç‚¹å‡»äº‹ä»¶
        container.querySelectorAll('.pagination-btn:not([disabled])').forEach(function(btn) {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                const page = parseInt(this.getAttribute('data-page'));
                if (page >= 1 && page <= totalPages) {
                    currentPage = page;
                    renderListings(page);
                    window.scrollTo(0, 0);
                }
            });
        });
    }

    async function fetchListings() {
        try {
            const res = await fetch('/api/properties');
            const response = await res.json();

            // æ£€æŸ¥APIå“åº”æ ¼å¼
            if (response.success && response.data) {
                listings = response.data;
            } else if (Array.isArray(response)) {
                // å…¼å®¹ç›´æ¥è¿”å›æ•°ç»„çš„æƒ…å†µ
                listings = response;
            } else {
                console.error('APIå“åº”æ ¼å¼é”™è¯¯:', response);
                listings = [];
            }

            renderListings();
        } catch (e) {
            console.error('æˆ¿æºæ•°æ®åŠ è½½å¤±è´¥', e);
            listings = [];
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        fetchListings();
        initializeAppointmentForm();
        // é¦–é¡µ/å…³äºæˆ‘ä»¬æŒ‰é’®äº‹ä»¶ç»‘å®š
        document.querySelectorAll('a').forEach(function(el) {
            if(el.textContent.includes('é¦–é¡µ')) {
                el.addEventListener('click', function(e) {
                    e.preventDefault();
                    showSection('home', true);
                    window.scrollTo(0,0);
                });
            }
            if(el.textContent.includes('å…³äºæˆ‘ä»¬')) {
                el.addEventListener('click', function(e) {
                    e.preventDefault();
                    showSection('about', true);
                    window.scrollTo(0,0);
                });
            }
        });
        
        // popstateäº‹ä»¶ç›‘å¬
        window.addEventListener('popstate', function(e) {
            var section = (e.state && e.state.section) || (location.hash.startsWith('#about') ? 'about' : (location.hash.startsWith('#detail') ? 'detail' : 'home'));
            var detailId = (e.state && e.state.detailId) || (location.hash.startsWith('#detail-') ? location.hash.replace('#detail-','') : undefined);
            showSection(section, false, detailId);
        });
        
        // é»˜è®¤æ˜¾ç¤º
        var defaultSection = location.hash.startsWith('#about') ? 'about' : (location.hash.startsWith('#detail-') ? 'detail' : 'home');
        var defaultDetailId = location.hash.startsWith('#detail-') ? location.hash.replace('#detail-','') : undefined;
        showSection(defaultSection, false, defaultDetailId);
        
        // åˆå§‹åŒ–ç­›é€‰é€‰é¡¹
        initializeFilters();

        // æœç´¢åŠŸèƒ½
        const searchBtn = document.getElementById('searchBtn');
        if(searchBtn) {
            searchBtn.addEventListener('click', performSearch);
        }

        // æ¸…é™¤ç­›é€‰æ¡ä»¶
        const clearFiltersBtn = document.getElementById('clearFilters');
        if(clearFiltersBtn) {
            clearFiltersBtn.addEventListener('click', clearFilters);
        }

        // é‡ç½®æŒ‰é’®
        const resetBtn = document.getElementById('resetBtn');
        if(resetBtn) {
            resetBtn.addEventListener('click', resetToDefault);
        }

        // æ’åºå˜åŒ–æ—¶æ™ºèƒ½æ’åº
        const sortBySelect = document.getElementById('sortBy');
        if(sortBySelect) {
            sortBySelect.addEventListener('change', handleSortChange);
        }

        // è¯¦æƒ…å›¾ç‰‡æ”¾å¤§é¢„è§ˆäº‹ä»¶
        document.body.addEventListener('click', function(e) {
            if (e.target.classList.contains('previewable-img') || e.target.classList.contains('detail-thumb')) {
                const imgs = Array.from(document.querySelectorAll('.previewable-img')).map(img => img.src);
                let idx = imgs.indexOf(e.target.src);
                if (idx === -1 && e.target.dataset.idx) idx = parseInt(e.target.dataset.idx);
                const modal = document.getElementById('img-preview-modal');
                const modalImg = document.getElementById('img-preview-img');
                modalImg.src = imgs[idx];
                modal.classList.remove('hidden');
                // åˆ‡æ¢
                function showImg(i) {
                    if (i < 0) i = imgs.length-1;
                    if (i >= imgs.length) i = 0;
                    modalImg.src = imgs[i];
                    idx = i;
                }
                document.getElementById('img-preview-prev').onclick = function(){ showImg(idx-1); };
                document.getElementById('img-preview-next').onclick = function(){ showImg(idx+1); };
                document.getElementById('img-preview-close').onclick = function(){ modal.classList.add('hidden'); };
                document.onkeydown = function(ev){ if(ev.key==='Escape'){ modal.classList.add('hidden'); } };
                modal.onclick = function(ev){ if(ev.target===modal){ modal.classList.add('hidden'); } };
            }
        });
    });

    // è¯¦æƒ…æ¨¡æ¿æ¸²æŸ“å‡½æ•°
    function renderDetail(listing) {
        if (!listing) return '<div class="p-8 text-center text-gray-500">æœªæ‰¾åˆ°æˆ¿æºä¿¡æ¯</div>';
        const recommends = listings.filter(l => l.id !== listing.id).slice(0, 3);
        // å”¯ä¸€ID
        const swiperId = `mySwiper-${listing.id}`;
        // å›¾ç‰‡é¢„è§ˆå¼¹çª—HTML
        const previewModal = `
          <div id="img-preview-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-80 hidden">
            <button id="img-preview-close" class="absolute top-4 right-8 text-white text-3xl font-bold">&times;</button>
            <button id="img-preview-prev" class="absolute left-4 top-1/2 -translate-y-1/2 text-white text-3xl font-bold">&#8592;</button>
            <img id="img-preview-img" src="" class="max-h-[80vh] max-w-[90vw] rounded shadow-2xl" />
            <button id="img-preview-next" class="absolute right-4 top-1/2 -translate-y-1/2 text-white text-3xl font-bold">&#8594;</button>
          </div>
        `;
        // è§†é¢‘æ™ºèƒ½åµŒå…¥
        function getVideoEmbed(url) {
          if (!url) return '';

          // æ£€æŸ¥æ˜¯å¦æ˜¯æœ¬åœ°ä¸Šä¼ çš„è§†é¢‘æ–‡ä»¶
          if (url.startsWith('static/images/') && /\.(mp4|webm|ogg)$/i.test(url)) {
            return `<video src="${url}" controls class="absolute inset-0 w-full h-full rounded" preload="metadata">
              <p>æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾ã€‚</p>
            </video>`;
          }

          // å¤–éƒ¨è§†é¢‘é“¾æ¥å¤„ç†
          if (/bilibili\.com\/video\//.test(url)) {
            // Bç«™
            const bvid = url.match(/video\/([a-zA-Z0-9]+)/);
            return bvid ? `<iframe src="https://player.bilibili.com/player.html?bvid=${bvid[1]}&autoplay=0" allowfullscreen class="absolute inset-0 w-full h-full"></iframe>` : '';
          } else if (/youtube\.com|youtu\.be/.test(url)) {
            // YouTube
            let vid = '';
            if (url.includes('embed/')) vid = url.split('embed/')[1];
            else if (url.includes('v=')) vid = url.split('v=')[1].split('&')[0];
            else if (url.includes('youtu.be/')) vid = url.split('youtu.be/')[1];
            return vid ? `<iframe src="https://www.youtube.com/embed/${vid}" allowfullscreen class="absolute inset-0 w-full h-full"></iframe>` : '';
          } else if (/qq\.com\/x\/cover\//.test(url)) {
            // è…¾è®¯è§†é¢‘ç®€å•æ”¯æŒ
            return `<iframe src="${url}" allowfullscreen class="absolute inset-0 w-full h-full"></iframe>`;
          } else if (/\.(mp4|webm|ogg)$/i.test(url)) {
            // ç›´é“¾è§†é¢‘æ–‡ä»¶
            return `<video src="${url}" controls class="absolute inset-0 w-full h-full rounded" preload="metadata">
              <p>æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾ã€‚</p>
            </video>`;
          } else if (url.startsWith('http')) {
            // å…¶ä»–å¤–éƒ¨é“¾æ¥ï¼Œå°è¯•ç”¨iframe
            return `<iframe src="${url}" allowfullscreen class="absolute inset-0 w-full h-full"></iframe>`;
          } else {
            // æ— æ³•è¯†åˆ«çš„æ ¼å¼
            return `<div class="absolute inset-0 w-full h-full flex items-center justify-center bg-gray-100 text-gray-500">
              <p>ä¸æ”¯æŒçš„è§†é¢‘æ ¼å¼</p>
            </div>`;
          }
        }
        return `
        ${previewModal}
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
          <nav class="flex" aria-label="Breadcrumb">
            <ol class="flex items-center space-x-4">
              <li>
                <div>
                  <a href="#" class="text-gray-400 hover:text-gray-500" onclick="window.history.back();return false;">
                    <i class="fas fa-home"></i>
                    <span class="sr-only">é¦–é¡µ</span>
                  </a>
                </div>
              </li>
              <li>
                <div class="flex items-center">
                  <i class="fas fa-chevron-right text-gray-400 text-sm"></i>
                  <span class="ml-4 text-sm font-medium text-indigo-600" aria-current="page">${listing.name}</span>
                </div>
              </li>
            </ol>
          </nav>
        </div>
        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
          <div class="lg:grid lg:grid-cols-3 lg:gap-8">
            <div class="lg:col-span-2">
              <h1 class="text-3xl font-bold text-gray-900 mb-4">${listing.name}</h1>
              <p class="text-lg text-gray-500 mb-6"><i class="fas fa-map-marker-alt text-red-500 mr-1"></i> ${listing.location}</p>
              <!-- è½®æ’­å›¾ -->
              <div class="swiper mySwiper mb-6 rounded-lg overflow-hidden shadow-lg" id="${swiperId}">
                <div class="swiper-wrapper">
                  ${listing.images.map(img => `<div class='swiper-slide'><img src='${img}' class='w-full h-[600px] object-contain bg-gray-100 previewable-img'></div>`).join('')}
                </div>
                <div class="swiper-button-next swiper-button-next-${listing.id} text-white"></div>
                <div class="swiper-button-prev swiper-button-prev-${listing.id} text-white"></div>
                <div class="swiper-pagination"></div>
              </div>
              <!-- ç¼©ç•¥å›¾ -->
              <div class="grid grid-cols-6 gap-2 mb-8">
                ${listing.images.map((img, idx) => `<div class='rounded overflow-hidden cursor-pointer aspect-[3/4] border border-gray-200 hover:border-indigo-500 ${idx===0?'ring-2 ring-indigo-400':''}'><img src='${img}' class='w-full h-full object-cover detail-thumb hover:opacity-75 transition-opacity duration-200' data-idx='${idx}'></div>`).join('')}
              </div>
              <!-- è§†é¢‘å±•ç¤º -->
              ${(listing.videos && listing.videos.length > 0) ? `
                <h2 class="text-xl font-bold text-gray-900 mb-4">è§†é¢‘å‚è§‚</h2>
                <div class="mb-8">
                  ${listing.videos.map((videoPath, idx) => {
                    // ç¡®ä¿è§†é¢‘è·¯å¾„æ­£ç¡®
                    const correctPath = videoPath.startsWith('/') ? videoPath : '/' + videoPath;
                    return `
                    <div class="${idx > 0 ? 'mt-6' : ''}">
                      <div class="relative pt-[56.25%] rounded-lg overflow-hidden shadow-lg bg-black">
                        <video
                          src="${correctPath}"
                          controls
                          class="absolute inset-0 w-full h-full rounded object-cover"
                          preload="metadata"
                          poster=""
                          controlsList="nodownload">
                          <p class="text-white text-center">æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾ã€‚</p>
                        </video>
                      </div>
                    </div>
                    `;
                  }).join('')}
                </div>
              ` : ''}

              <!-- å¤–é“¾è§†é¢‘ -->
              ${(listing.video && listing.video.trim() && listing.video !== 'undefined') ? `
                <div class="bg-white shadow rounded-lg p-6 mb-8">
                  <h2 class="text-xl font-bold text-gray-900 mb-4">ç›¸å…³è§†é¢‘é“¾æ¥</h2>
                  <div class="flex items-center p-4 bg-blue-50 rounded-lg border border-blue-200">
                    <i class="fas fa-video text-blue-600 text-xl mr-3"></i>
                    <div class="flex-1">
                      <p class="text-gray-700 mb-1">æˆ¿æºä»‹ç»è§†é¢‘</p>
                     
                    </div>
                    <a href="${listing.video}" target="_blank" class="ml-4 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                      <i class="fas fa-external-link-alt mr-2"></i>è§‚çœ‹è§†é¢‘
                    </a>
                  </div>
                </div>
              ` : ''}
              <!-- è¯¦ç»†ä¿¡æ¯ -->
              <div class="bg-white shadow rounded-lg p-6 mb-8">
                <h2 class="text-xl font-bold text-gray-900 mb-4">æˆ¿æºä»‹ç»</h2>
                ${(() => {
                  // ä¼˜å…ˆæ˜¾ç¤ºç”¨æˆ·å¡«å†™çš„description
                  if (listing.description && listing.description.trim()) {
                    return `<p class="text-gray-600 mb-4">${listing.description}</p>`;
                  }
                  // å¦‚æœæ²¡æœ‰descriptionï¼Œæ£€æŸ¥descæ•°ç»„ï¼ˆæ’é™¤é»˜è®¤æç¤ºï¼‰
                  if (listing.desc && listing.desc.length > 0) {
                    const validDesc = listing.desc.filter(d =>
                      d && d.trim() &&
                      !d.includes('æœ¬æˆ¿æºæš‚æ— è¯¦ç»†ä»‹ç»') &&
                      !d.includes('æ¬¢è¿è”ç³»æˆ¿ä¸œè·å–æ›´å¤šä¿¡æ¯')
                    );
                    if (validDesc.length > 0) {
                      return validDesc.map(d => `<p class="text-gray-600 mb-4">${d}</p>`).join('');
                    }
                  }
                  // éƒ½æ²¡æœ‰æ—¶æ˜¾ç¤ºæš‚æ— ä»‹ç»
                  return '<p class="text-gray-600 mb-4">æš‚æ— è¯¦ç»†ä»‹ç»</p>';
                })()}
              </div>
              <!-- è®¾æ–½å’ŒæœåŠ¡ -->
              <div class="bg-white shadow rounded-lg p-6 mb-8">
                <h2 class="text-xl font-bold text-gray-900 mb-4">è®¾æ–½å’ŒæœåŠ¡</h2>
                <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                  ${listing.facilities.map(f => `<div class='flex items-center'><i class='fas ${f.icon} text-indigo-600 mr-2'></i><span class='text-gray-700'>${f.label}</span></div>`).join('')}
                </div>
              </div>
              <!-- å‘¨è¾¹ç¯å¢ƒ -->
              <div class="bg-white shadow rounded-lg p-6 mb-8">
                <h2 class="text-xl font-bold text-gray-900 mb-4">å‘¨è¾¹ç¯å¢ƒ</h2>
                <div class="rounded-lg overflow-hidden mb-4">
                  <iframe class="w-full h-80" src="${listing.map}" style="border:0;" allowfullscreen="" loading="lazy"></iframe>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">äº¤é€š</h3>
                    <ul class="space-y-2 text-gray-600">
                      ${listing.traffic.map(t => `<li class='flex items-start'><i class='fas ${t.icon} mt-1 text-indigo-600 mr-2'></i><span>${t.label}</span></li>`).join('')}
                    </ul>
                  </div>
                  <div>
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">å‘¨è¾¹è®¾æ–½</h3>
                    <ul class="space-y-2 text-gray-600">
                      ${listing.surroundings.map(s => `<li class='flex items-start'><i class='fas ${s.icon} mt-1 text-indigo-600 mr-2'></i><span>${s.label}</span></li>`).join('')}
                    </ul>
                  </div>
                </div>
              </div>
            </div>
            <!-- å³ä¾§è¾¹æ  -->
            <div class="mt-8 lg:mt-0">
              <!-- ä»·æ ¼å’Œé¢„è®¢ -->
              <div class="bg-white shadow rounded-lg p-6 mb-6 sticky top-6">
                <div class="flex justify-between items-center mb-4">
                  <span class="text-lg font-bold text-gray-900">ç§Ÿé‡‘</span>
                  <span class="text-2xl font-bold text-indigo-600">${listing.currency || ''}${listing.rent}</span>
                </div>
                <div class="border-t border-b border-gray-200 py-4 my-4">
                  <div class="flex justify-between mb-2">
                    <span class="text-gray-600">æŠ¼é‡‘</span>
                    <span class="text-gray-900 font-medium">${listing.currency || ''}${listing.deposit}</span>
                  </div>
                  <div class="flex justify-between mb-2">
                    <span class="text-gray-600">æ°´ç”µè´¹</span>
                    <span class="text-gray-900 font-medium">${listing.currency || ''}${listing.utility}</span>
                  </div>
                  <div class="flex justify-between">
                    <span class="text-gray-600">æœ€çŸ­ç§ŸæœŸ</span>
                    <span class="text-gray-900 font-medium">${listing.minTerm}</span>
                  </div>
                </div>
                <div class="space-y-4">
                  <button id="favoriteBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-md transition duration-200" onclick="toggleFavorite()">
                    <i id="favoriteIcon" class="fas fa-heart mr-2"></i>
                    <span id="favoriteText">åŠ å…¥æ”¶è—</span>
                  </button>
                </div>
              </div>
              <!-- æˆ¿ä¸œä¿¡æ¯ -->
              <div class="bg-white shadow rounded-lg p-6 mb-6">
                <h3 class="text-lg font-bold text-gray-900 mb-4">è”ç³»ç®¡ç†å‘˜</h3>
                <div class="flex items-center mb-4">
                  <img class="h-12 w-12 rounded-full mr-4" src="${listing.landlord.avatar || '/static/images/icon_lg.png'}" alt="ç®¡ç†å‘˜å¤´åƒ">
                  <div>
                    <p class="text-base font-medium text-gray-900">${listing.landlord.name || 'æˆ¿æºç®¡ç†å‘˜'}</p>
                    <p class="text-sm text-gray-500">ä¸“ä¸šæˆ¿æºé¡¾é—®</p>
                  </div>
                </div>
                <div class="space-y-3 mb-4">
                  <div class="flex items-center text-gray-700"><i class="fas fa-phone-alt text-indigo-600 mr-3"></i><span>${listing.landlord.phone}</span></div>
                  <div class="flex items-center text-gray-700"><i class="fas fa-envelope text-indigo-600 mr-3"></i><span>${listing.landlord.email}</span></div>
                  <div class="flex items-center text-gray-700"><i class="fab fa-weixin text-indigo-600 mr-3"></i><span>${listing.landlord.wechat}</span></div>
                </div>
              </div>
              <!-- é¢„çº¦çœ‹æˆ¿ -->
              <div class="bg-white shadow rounded-lg p-6 mb-6">
                <h3 class="text-lg font-bold text-gray-900 mb-4">é¢„çº¦çœ‹æˆ¿</h3>
                <form id="appointmentForm">
                  <input type="hidden" id="propertyId" name="property_id" value="${listing.id}">
                  <div class="mb-4">
                    <label for="appointmentDate" class="block text-sm font-medium text-gray-700 mb-1">é€‰æ‹©æ—¥æœŸ</label>
                    <input type="date" id="appointmentDate" name="preferred_date" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                  </div>
                  <div class="mb-4">
                    <label for="appointmentTime" class="block text-sm font-medium text-gray-700 mb-1">é€‰æ‹©æ—¶é—´</label>
                    <select id="appointmentTime" name="preferred_time" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                      <option value="">è¯·é€‰æ‹©æ—¶é—´</option>
                      <option value="ä¸Šåˆ 9:00">ä¸Šåˆ 9:00</option>
                      <option value="ä¸Šåˆ 10:00">ä¸Šåˆ 10:00</option>
                      <option value="ä¸Šåˆ 11:00">ä¸Šåˆ 11:00</option>
                      <option value="ä¸‹åˆ 12:00">ä¸‹åˆ 12:00</option>
                      <option value="ä¸‹åˆ 1:00">ä¸‹åˆ 1:00</option>
                      <option value="ä¸‹åˆ 2:00">ä¸‹åˆ 2:00</option>
                      <option value="ä¸‹åˆ 3:00">ä¸‹åˆ 3:00</option>
                      <option value="ä¸‹åˆ 4:00">ä¸‹åˆ 4:00</option>
                      <option value="ä¸‹åˆ 5:00">ä¸‹åˆ 5:00</option>
                    </select>
                  </div>
                  <div class="mb-4">
                    <label for="appointmentName" class="block text-sm font-medium text-gray-700 mb-1">æ‚¨çš„å§“å</label>
                    <input type="text" id="appointmentName" name="name" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                  </div>
                  <div class="mb-4">
                    <label for="appointmentPhone" class="block text-sm font-medium text-gray-700 mb-1">è”ç³»ç”µè¯</label>
                    <input type="tel" id="appointmentPhone" name="phone" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                  </div>
                  <div class="mb-4">
                    <label for="appointmentEmail" class="block text-sm font-medium text-gray-700 mb-1">é‚®ç®± (å¯é€‰)</label>
                    <input type="email" id="appointmentEmail" name="email" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                  </div>
                  <div class="mb-4">
                    <label for="appointmentMessage" class="block text-sm font-medium text-gray-700 mb-1">å¤‡æ³¨ä¿¡æ¯ (å¯é€‰)</label>
                    <textarea id="appointmentMessage" name="message" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="è¯·è¾“å…¥æ‚¨çš„ç‰¹æ®Šè¦æ±‚æˆ–é—®é¢˜..."></textarea>
                  </div>
                  <button type="submit" id="appointmentSubmitBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md transition duration-200">
                    <span id="appointmentSubmitText">æäº¤é¢„çº¦</span>
                    <span id="appointmentSubmitLoading" class="hidden">
                      <i class="fas fa-spinner fa-spin mr-2"></i>æäº¤ä¸­...
                    </span>
                  </button>
                </form>
              </div>
              <!-- æ¨èæˆ¿æº -->
              <div class="bg-white shadow rounded-lg p-6">
                <h3 class="text-lg font-bold text-gray-900 mb-4">æ‚¨å¯èƒ½ä¹Ÿå–œæ¬¢</h3>
                <div class="space-y-4">
                  ${recommends.map(r => `
                  <a href="#" class="block hover:bg-gray-50 rounded-md p-3 transition duration-200" onclick="event.preventDefault();window.scrollTo(0,0);showSection('detail',true,${r.id});">
                    <div class="flex">
                      <img src="${r.images[0]}" alt="${r.name}" class="w-20 h-16 object-cover rounded-md">
                      <div class="ml-3">
                        <p class="text-sm font-medium text-gray-900">${r.name}</p>
                        <p class="text-xs text-gray-500">${r.location ? r.location.split(',')[0] : ''}</p>
                        <p class="text-sm font-bold text-indigo-600">${r.currency || ''}${r.price}</p>
                      </div>
                    </div>
                  </a>
                  `).join('')}
                </div>
              </div>
            </div>
          </div>
        </main>
      `;
    }

    // å°†showSectionå®šä¹‰ä¸ºå…¨å±€å‡½æ•°ï¼Œè€Œä¸æ˜¯åœ¨DOMContentLoadedä¸­å®šä¹‰
    function showSection(section, push, detailId) {
        document.getElementById('home-section').style.display = section === 'home' ? '' : 'none';
        document.getElementById('about-section').style.display = section === 'about' ? '' : 'none';
        document.getElementById('detail-section').style.display = section === 'detail' ? '' : 'none';
        if(section === 'detail') {
            // æ¸²æŸ“è¯¦æƒ…å†…å®¹
            fetchDetail(detailId).then(listing => {
                document.getElementById('detail-section').innerHTML = renderDetail(listing);

                // è®¾ç½®å½“å‰æˆ¿æºIDå¹¶æ£€æŸ¥æ”¶è—çŠ¶æ€
                if (listing) {
                    currentPropertyId = listing.id;
                    checkFavoriteStatus(listing.id);
                }

                // é”€æ¯æ—§Swiperå®ä¾‹
                if (window.swiperInstance && window.swiperInstance.destroy) {
                    window.swiperInstance.destroy(true, true);
                }
                // æ¸²æŸ“ååˆå§‹åŒ– Swiper
                if(window.Swiper && listing){
                    setTimeout(function(){
                        const swiperId = `#mySwiper-${listing.id}`;
                        const nextBtn = `.swiper-button-next-${listing.id}`;
                        const prevBtn = `.swiper-button-prev-${listing.id}`;
                        const pagination = `${swiperId} .swiper-pagination`;
                        window.swiperInstance = new Swiper(swiperId, {
                            slidesPerView: 1,
                            spaceBetween: 30,
                            loop: true,
                            autoplay: { delay: 3000, disableOnInteraction: false },
                            pagination: { el: pagination, clickable: true },
                            navigation: { nextEl: nextBtn, prevEl: prevBtn }
                        });
                        // ç¼©ç•¥å›¾ç‚¹å‡»åˆ‡æ¢å¤§å›¾
                        document.querySelectorAll('.detail-thumb').forEach((thumb, idx) => {
                            thumb.addEventListener('click', () => {
                                if(window.swiperInstance) window.swiperInstance.slideTo(idx+1);
                            });
                        });
                    }, 200);
                }
            });
        }
        if (push) {
            var url = section === 'about' ? '#about' : (section === 'detail' ? ('#detail-' + detailId) : '#home');
            history.pushState({section: section, detailId: detailId}, '', url);
        }
    }

    async function fetchDetail(id) {
        try {
            const res = await fetch(`/api/property/${id}`);
            if (!res.ok) throw new Error('æˆ¿æºè¯¦æƒ…åŠ è½½å¤±è´¥');
            const data = await res.json();
            return data;
        } catch (e) {
            console.error(e);
            return null;
        }
    }

    // æ”¶è—åŠŸèƒ½ç›¸å…³
    let currentPropertyId = null;

    // åˆ‡æ¢æ”¶è—çŠ¶æ€
    async function toggleFavorite() {
        if (!currentPropertyId) {
            showMessage('æˆ¿æºä¿¡æ¯åŠ è½½ä¸­ï¼Œè¯·ç¨åå†è¯•', 'error');
            return;
        }

        const favoriteBtn = document.getElementById('favoriteBtn');
        const favoriteIcon = document.getElementById('favoriteIcon');
        const favoriteText = document.getElementById('favoriteText');

        // ç¦ç”¨æŒ‰é’®é˜²æ­¢é‡å¤ç‚¹å‡»
        favoriteBtn.disabled = true;

        try {
            // æ£€æŸ¥å½“å‰æ”¶è—çŠ¶æ€
            const checkRes = await fetch(`/api/favorites/check/${currentPropertyId}`);
            const checkData = await checkRes.json();

            if (!checkData.success) {
                throw new Error(checkData.message || 'æ£€æŸ¥æ”¶è—çŠ¶æ€å¤±è´¥');
            }

            // å¦‚æœéœ€è¦ç™»å½•
            if (checkData.need_login) {
                showMessage('è¯·å…ˆç™»å½•åå†æ”¶è—', 'error');
                // æ‰“å¼€ç™»å½•å¼¹çª—
                const modal = document.getElementById('auth-modal');
                if (modal) {
                    modal.style.display = 'flex';
                }
                return;
            }

            let response;
            if (checkData.is_favorited) {
                // å–æ¶ˆæ”¶è—
                response = await fetch(`/api/favorites/${currentPropertyId}`, {
                    method: 'DELETE'
                });
            } else {
                // æ·»åŠ æ”¶è—
                response = await fetch('/api/favorites', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        property_id: currentPropertyId
                    })
                });
            }

            const data = await response.json();

            if (data.success) {
                // æ›´æ–°æŒ‰é’®çŠ¶æ€
                updateFavoriteButton(!checkData.is_favorited);
                showMessage(data.message, 'success');
            } else {
                if (data.need_login) {
                    showMessage('è¯·å…ˆç™»å½•åå†æ”¶è—', 'error');
                    // æ‰“å¼€ç™»å½•å¼¹çª—
                    const modal = document.getElementById('auth-modal');
                    if (modal) {
                        modal.style.display = 'flex';
                    }
                } else {
                    throw new Error(data.message || 'æ“ä½œå¤±è´¥');
                }
            }

        } catch (error) {
            console.error('æ”¶è—æ“ä½œå¤±è´¥:', error);
            showMessage(error.message || 'æ”¶è—æ“ä½œå¤±è´¥ï¼Œè¯·ç¨åå†è¯•', 'error');
        } finally {
            // é‡æ–°å¯ç”¨æŒ‰é’®
            favoriteBtn.disabled = false;
        }
    }

    // æ›´æ–°æ”¶è—æŒ‰é’®çŠ¶æ€
    function updateFavoriteButton(isFavorited) {
        const favoriteBtn = document.getElementById('favoriteBtn');
        const favoriteIcon = document.getElementById('favoriteIcon');
        const favoriteText = document.getElementById('favoriteText');

        if (isFavorited) {
            // å·²æ”¶è—çŠ¶æ€
            favoriteBtn.className = 'w-full bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-4 rounded-md transition duration-200';
            favoriteIcon.className = 'fas fa-heart mr-2';
            favoriteText.textContent = 'å·²æ”¶è—';
        } else {
            // æœªæ”¶è—çŠ¶æ€
            favoriteBtn.className = 'w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-md transition duration-200';
            favoriteIcon.className = 'far fa-heart mr-2';
            favoriteText.textContent = 'åŠ å…¥æ”¶è—';
        }
    }

    // æ£€æŸ¥å¹¶æ›´æ–°æ”¶è—çŠ¶æ€
    async function checkFavoriteStatus(propertyId) {
        try {
            const response = await fetch(`/api/favorites/check/${propertyId}`);
            const data = await response.json();

            if (data.success) {
                updateFavoriteButton(data.is_favorited);
            }
        } catch (error) {
            console.error('æ£€æŸ¥æ”¶è—çŠ¶æ€å¤±è´¥:', error);
            // é»˜è®¤æ˜¾ç¤ºæœªæ”¶è—çŠ¶æ€
            updateFavoriteButton(false);
        }
    }

    // æ˜¾ç¤ºæ¶ˆæ¯æç¤º
    function showMessage(message, type = 'info') {
        // åˆ›å»ºæ¶ˆæ¯æç¤ºå…ƒç´ 
        const messageDiv = document.createElement('div');
        messageDiv.className = `fixed top-4 right-4 z-50 px-6 py-3 rounded-lg shadow-lg text-white font-medium transition-all duration-300 transform translate-x-full`;

        // æ ¹æ®ç±»å‹è®¾ç½®é¢œè‰²
        if (type === 'success') {
            messageDiv.className += ' bg-green-500';
        } else if (type === 'error') {
            messageDiv.className += ' bg-red-500';
        } else {
            messageDiv.className += ' bg-blue-500';
        }

        messageDiv.textContent = message;
        document.body.appendChild(messageDiv);

        // æ˜¾ç¤ºåŠ¨ç”»
        setTimeout(() => {
            messageDiv.classList.remove('translate-x-full');
        }, 100);

        // 3ç§’åè‡ªåŠ¨éšè—
        setTimeout(() => {
            messageDiv.classList.add('translate-x-full');
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.parentNode.removeChild(messageDiv);
                }
            }, 300);
        }, 3000);
    }

    // ç™»å½•/æ³¨å†Œå¼¹çª—é€»è¾‘
    (function(){
      const modal = document.getElementById('auth-modal');
      const openBtn = document.querySelector('nav .fa-user-circle')?.closest('button');
      const closeBtn = document.getElementById('auth-modal-close');
      const showLoginBtn = document.getElementById('show-login');
      const showRegisterBtn = document.getElementById('show-register');
      const loginForm = document.getElementById('login-form');
      const registerForm = document.getElementById('register-form');
      const sendCodeBtn = document.getElementById('send-code-btn');
      const msgBox = document.getElementById('auth-msg');
      let codeTimer = null, codeTime = 60;

      // æ‰“å¼€å¼¹çª—
      if(openBtn) openBtn.onclick = () => { modal.style.display = 'flex'; showLogin(); };
      // å…³é—­å¼¹çª—
      closeBtn.onclick = () => { modal.style.display = 'none'; clearMsg(); };
      // åˆ‡æ¢ç™»å½•/æ³¨å†Œ
      showLoginBtn.onclick = showLogin;
      showRegisterBtn.onclick = showRegister;
      function showLogin(){
        loginForm.style.display = '';
        registerForm.style.display = 'none';
        showLoginBtn.classList.add('border-yellow-500');
        showRegisterBtn.classList.remove('border-yellow-500');
        clearMsg();
      }
      function showRegister(){
        loginForm.style.display = 'none';
        registerForm.style.display = '';
        showRegisterBtn.classList.add('border-yellow-500');
        showLoginBtn.classList.remove('border-yellow-500');
        clearMsg();
      }
      function clearMsg(){ msgBox.textContent = ''; }

      // å‘é€éªŒè¯ç 
      sendCodeBtn.onclick = async function(){
        const email = registerForm.email.value.trim();
        if(!email) { msgBox.textContent = 'è¯·è¾“å…¥é‚®ç®±'; return; }
        sendCodeBtn.disabled = true;
        sendCodeBtn.textContent = 'å‘é€ä¸­...';
        try {
          const res = await fetch('/api/send_email_code', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({email})
          });
          const data = await res.json();
          if(data.success){
            msgBox.textContent = 'éªŒè¯ç å·²å‘é€ï¼Œè¯·æŸ¥æ”¶é‚®ç®±';
            startTimer();
          }else{
            msgBox.textContent = data.msg || 'å‘é€å¤±è´¥';
            sendCodeBtn.disabled = false;
            sendCodeBtn.textContent = 'å‘é€éªŒè¯ç ';
          }
        }catch(e){
          msgBox.textContent = 'ç½‘ç»œé”™è¯¯';
          sendCodeBtn.disabled = false;
          sendCodeBtn.textContent = 'å‘é€éªŒè¯ç ';
        }
      };
      function startTimer(){
        let t = codeTime;
        sendCodeBtn.disabled = true;
        sendCodeBtn.textContent = t + 'såé‡å‘';
        codeTimer = setInterval(()=>{
          t--;
          sendCodeBtn.textContent = t + 'såé‡å‘';
          if(t<=0){
            clearInterval(codeTimer);
            sendCodeBtn.disabled = false;
            sendCodeBtn.textContent = 'å‘é€éªŒè¯ç ';
          }
        },1000);
      }

      // æ³¨å†Œè¡¨å•æäº¤
      registerForm.onsubmit = async function(e){
        e.preventDefault();
        const email = registerForm.email.value.trim();
        const code = registerForm.code.value.trim();
        const password = registerForm.password.value;
        if(!email||!code||!password){ msgBox.textContent = 'è¯·å¡«å†™å®Œæ•´ä¿¡æ¯'; return; }
        try{
          const res = await fetch('/api/register',{
            method:'POST',headers:{'Content-Type':'application/json'},
            body:JSON.stringify({email,code,password})
          });
          const data = await res.json();
          if(data.success){
            msgBox.textContent = 'æ³¨å†ŒæˆåŠŸï¼Œè¯·ç™»å½•';
            setTimeout(()=>{ showLogin(); }, 1000);
          }else{
            msgBox.textContent = data.msg || 'æ³¨å†Œå¤±è´¥';
          }
        }catch(e){ msgBox.textContent = 'ç½‘ç»œé”™è¯¯'; }
      };

      // ç™»å½•è¡¨å•æäº¤
      loginForm.onsubmit = async function(e){
        e.preventDefault();
        const email = loginForm.email.value.trim();
        const password = loginForm.password.value;
        if(!email||!password){ msgBox.textContent = 'è¯·å¡«å†™é‚®ç®±å’Œå¯†ç '; return; }
        try{
          const res = await fetch('/api/login',{
            method:'POST',headers:{'Content-Type':'application/json'},
            body:JSON.stringify({email,password})
          });
          const data = await res.json();
          if(data.success){
            msgBox.textContent = 'ç™»å½•æˆåŠŸ';
            setTimeout(()=>{ modal.style.display='none'; updateUserUI(email); }, 800);
          }else{
            msgBox.textContent = data.msg || 'ç™»å½•å¤±è´¥';
          }
        }catch(e){ msgBox.textContent = 'ç½‘ç»œé”™è¯¯'; }
      };

      // ç™»å½•åUIåˆ‡æ¢
      function updateUserUI(email){
        // ç®€å•ç¤ºä¾‹ï¼šå°†ç™»å½•/æ³¨å†ŒæŒ‰é’®æ›¿æ¢ä¸ºé‚®ç®±å’Œé€€å‡º
        const nav = document.querySelector('nav .fa-user-circle')?.closest('button');
        if(nav){
          nav.innerHTML = `<i class=\"fas fa-user mr-2\"></i><span>${email}</span> <button id=\"logout-btn\" class=\"ml-2 text-sm text-yellow-700 underline\">é€€å‡º</button>`;
          document.getElementById('logout-btn').onclick = function(){
            fetch('/admin/logout').then(()=>location.reload());
          };
        }
      }



      // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æµ‹ç™»å½•çŠ¶æ€
      window.addEventListener('DOMContentLoaded', async function() {
        // æ£€æŸ¥URLå‚æ•°ï¼Œå¦‚æœéœ€è¦ç™»å½•åˆ™æ˜¾ç¤ºæç¤º
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('login') === 'required') {
          showMessage('è¯·å…ˆç™»å½•åå†æŸ¥çœ‹æ”¶è—', 'error');
          // æ‰“å¼€ç™»å½•å¼¹çª—
          const modal = document.getElementById('auth-modal');
          if (modal) {
            modal.style.display = 'flex';
          }
          // æ¸…é™¤URLå‚æ•°
          window.history.replaceState({}, document.title, window.location.pathname);
        }

        // æ£€æŸ¥æ˜¯å¦æœ‰é¢„çº¦å‚æ•°
        const appointmentParams = {
          property_id: urlParams.get('property_id'),
          preferred_date: urlParams.get('preferred_date'),
          preferred_time: decodeURIComponent(urlParams.get('preferred_time') || ''),
          name: urlParams.get('name'),
          phone: urlParams.get('phone'),
          email: urlParams.get('email'),
          message: urlParams.get('message')
        };

        // å¦‚æœæœ‰é¢„çº¦å‚æ•°ï¼Œæ¸…ç†URL
        if (appointmentParams.property_id) {
          const newUrl = window.location.pathname + window.location.hash;
          window.history.replaceState({}, document.title, newUrl);
        }

        // åŠ è½½é¡µè„šè”ç³»ä¿¡æ¯
        loadFooterContact();

        // æ£€æµ‹ç™»å½•çŠ¶æ€
        fetch('/api/current_user').then(r=>r.json()).then(data=>{
          if(data.success && data.email){
            updateUserUI(data.email);
          }
        });

        // å¤„ç†é¢„çº¦å‚æ•°ï¼ˆåœ¨é¡µé¢åŠ è½½å®Œæˆåï¼‰
        if (appointmentParams.property_id) {
          setTimeout(() => {
            handleUrlAppointmentParams(appointmentParams);
          }, 1000); // ç­‰å¾…é¡µé¢å®Œå…¨åŠ è½½
        }
      });

      // åŠ è½½é¡µè„šè”ç³»ä¿¡æ¯
      async function loadFooterContact() {
        try {
          const response = await fetch('/api/contact_info');
          const data = await response.json();

          if (data.success && data.contact) {
            const contact = data.contact;

            // æ›´æ–°åœ°å€
            const addressElement = document.getElementById('footerAddress');
            if (contact.address) {
              addressElement.textContent = contact.address;
            } else {
              addressElement.textContent = 'åœ°å€æœªè®¾ç½®';
            }

            // æ›´æ–°ç”µè¯
            const phoneElement = document.getElementById('footerPhone');
            if (contact.phone) {
              phoneElement.textContent = contact.phone;
            } else {
              phoneElement.textContent = 'ç”µè¯æœªè®¾ç½®';
            }

            // æ›´æ–°é‚®ç®±
            const emailElement = document.getElementById('footerEmail');
            if (contact.email) {
              emailElement.textContent = contact.email;
            } else {
              emailElement.textContent = 'info@unihome.com';
            }
          } else {
            // å¦‚æœè·å–å¤±è´¥ï¼Œæ˜¾ç¤ºé»˜è®¤ä¿¡æ¯
            document.getElementById('footerAddress').textContent = 'åœ°å€æœªè®¾ç½®';
            document.getElementById('footerPhone').textContent = 'ç”µè¯æœªè®¾ç½®';
            document.getElementById('footerEmail').textContent = 'info@unihome.com';
          }
        } catch (error) {
          console.error('åŠ è½½è”ç³»ä¿¡æ¯å¤±è´¥:', error);
          // æ˜¾ç¤ºé»˜è®¤ä¿¡æ¯
          document.getElementById('footerAddress').textContent = 'åœ°å€æœªè®¾ç½®';
          document.getElementById('footerPhone').textContent = 'ç”µè¯æœªè®¾ç½®';
          document.getElementById('footerEmail').textContent = 'info@unihome.com';
        }
      }
    })();

    // ç­›é€‰å’Œæœç´¢åŠŸèƒ½
    let currentSearchParams = {};
    let searchCurrentPage = 1;

    // åˆå§‹åŒ–ç­›é€‰é€‰é¡¹
    async function initializeFilters() {
        try {
            // åŠ è½½ä½ç½®é€‰é¡¹
            const locationsResponse = await fetch('/api/locations');
            const locationsData = await locationsResponse.json();

            if (locationsData.success) {
                const locationSelect = document.getElementById('location');
                locationSelect.innerHTML = '<option value="">å…¨éƒ¨</option>';

                // æŒ‰å›½å®¶åˆ†ç»„æ˜¾ç¤ºä½ç½®
                for (const country in locationsData.data) {
                    const countryGroup = document.createElement('optgroup');
                    countryGroup.label = country === 'Canada' ? 'ğŸ‡¨ğŸ‡¦ åŠ æ‹¿å¤§' : 'ğŸ‡¨ğŸ‡³ ä¸­å›½';

                    locationsData.data[country].forEach(location => {
                        if (location.is_active) {
                            const option = document.createElement('option');
                            option.value = location.name;
                            option.textContent = location.display_name;
                            countryGroup.appendChild(option);
                        }
                    });

                    locationSelect.appendChild(countryGroup);
                }
            }

            // åŠ è½½æˆ¿å±‹ç±»å‹é€‰é¡¹
            const typesResponse = await fetch('/api/property_types');
            const typesData = await typesResponse.json();

            if (typesData.success) {
                const typeSelect = document.getElementById('type');
                typeSelect.innerHTML = '<option value="">å…¨éƒ¨</option>';

                typesData.data.forEach(type => {
                    if (type.is_active) {
                        const option = document.createElement('option');
                        option.value = type.name;
                        option.textContent = type.name;
                        typeSelect.appendChild(option);
                    }
                });
            }

            // åŠ è½½ä»·æ ¼åŒºé—´é€‰é¡¹
            const pricesResponse = await fetch('/api/price_ranges');
            const pricesData = await pricesResponse.json();

            if (pricesData.success) {
                const priceSelect = document.getElementById('price');
                priceSelect.innerHTML = '<option value="">å…¨éƒ¨</option>';

                pricesData.data.forEach(range => {
                    const option = document.createElement('option');
                    option.value = JSON.stringify({
                        min_price: range.min,
                        max_price: range.max,
                        currency: range.currency
                    });
                    option.textContent = range.label;
                    priceSelect.appendChild(option);
                });
            }

        } catch (error) {
            console.error('åˆå§‹åŒ–ç­›é€‰é€‰é¡¹å¤±è´¥:', error);
        }
    }

    // æ‰§è¡Œæœç´¢
    async function performSearch() {
        const location = document.getElementById('location').value;
        const priceValue = document.getElementById('price').value;
        const type = document.getElementById('type').value;
        const sortValue = document.getElementById('sortBy').value;

        // è§£æä»·æ ¼å‚æ•°
        let priceParams = {};
        if (priceValue) {
            try {
                priceParams = JSON.parse(priceValue);
            } catch (e) {
                console.error('ä»·æ ¼å‚æ•°è§£æå¤±è´¥:', e);
            }
        }

        // è§£ææ’åºå‚æ•°
        const [sortBy, sortOrder] = sortValue.split('_');

        // æ„å»ºæœç´¢å‚æ•°
        const searchParams = new URLSearchParams({
            page: searchCurrentPage,
            per_page: 12
        });

        if (location) searchParams.append('location', location);
        if (type) searchParams.append('property_type', type);
        if (priceParams.min_price !== undefined) searchParams.append('min_price', priceParams.min_price);
        if (priceParams.max_price !== undefined) searchParams.append('max_price', priceParams.max_price);
        if (priceParams.currency) searchParams.append('currency', priceParams.currency);
        if (sortBy) searchParams.append('sort_by', sortBy);
        if (sortOrder) searchParams.append('sort_order', sortOrder);

        currentSearchParams = Object.fromEntries(searchParams);

        try {
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            showLoading(true);
            showSearchView();

            // å‘é€æœç´¢è¯·æ±‚
            const response = await fetch(`/api/properties?${searchParams}`);
            const data = await response.json();

            if (data.success) {
                displaySearchResults(data.data, data.pagination);
            } else {
                showNoResults();
            }

        } catch (error) {
            console.error('æœç´¢å¤±è´¥:', error);
            showNoResults();
        } finally {
            showLoading(false);
        }
    }

    // æ˜¾ç¤ºæœç´¢ç»“æœ
    function displaySearchResults(properties, pagination) {
        const propertyList = document.getElementById('propertyList');
        const resultCount = document.getElementById('resultCount');

        if (properties.length === 0) {
            showNoResults();
            return;
        }

        // æ›´æ–°ç»“æœè®¡æ•°
        resultCount.textContent = `æ‰¾åˆ° ${pagination.total} ä¸ªæˆ¿æº`;

        // æ¸²æŸ“æˆ¿æºå¡ç‰‡
        propertyList.innerHTML = properties.map(property => `
            <div class="bg-white rounded-lg shadow-md overflow-hidden hover:shadow-lg transition-shadow duration-300">
                <div class="relative">
                    ${property.images && property.images.length > 0 ? `
                        <img src="${property.images[0]}" alt="${property.name}" class="w-full h-48 object-cover">
                    ` : `
                        <div class="w-full h-48 bg-gray-200 flex items-center justify-center">
                            <i class="fas fa-home text-4xl text-gray-400"></i>
                        </div>
                    `}
                    <div class="absolute top-2 right-2">
                        <span class="bg-indigo-600 text-white px-2 py-1 rounded-full text-xs font-medium">
                            ${property.currency}${property.price}
                        </span>
                    </div>
                </div>
                <div class="p-4">
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">${property.name}</h3>
                    <div class="flex items-center text-sm text-gray-600 mb-2">
                        <i class="fas fa-map-marker-alt mr-1"></i>
                        <span>${property.location}</span>
                    </div>
                    <div class="flex items-center text-sm text-gray-600 mb-3">
                        <i class="fas fa-home mr-1"></i>
                        <span>${property.property_type}</span>
                    </div>
                    <p class="text-gray-600 text-sm mb-4 line-clamp-2">${property.description || 'æš‚æ— æè¿°'}</p>
                    <div class="flex justify-between items-center">
                        <span class="text-lg font-bold text-indigo-600">${property.currency}${property.price}/æœˆ</span>
                        <a href="#detail-${property.id}" class="bg-indigo-600 text-white px-4 py-2 rounded-md text-sm hover:bg-indigo-700 transition-colors">
                            æŸ¥çœ‹è¯¦æƒ…
                        </a>
                    </div>
                </div>
            </div>
        `).join('');

        // æ˜¾ç¤ºåˆ†é¡µ
        if (pagination.pages > 1) {
            displayPagination(pagination);
        } else {
            document.getElementById('pagination').style.display = 'none';
        }

        // éšè—æ— ç»“æœæç¤º
        document.getElementById('noResults').style.display = 'none';
    }

    // æ˜¾ç¤ºåˆ†é¡µ
    function displayPagination(pagination) {
        const paginationContainer = document.getElementById('pagination').querySelector('nav');
        let paginationHTML = '';

        // ä¸Šä¸€é¡µ
        if (pagination.has_prev) {
            paginationHTML += `
                <button class="pagination-btn relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50" data-page="${pagination.page - 1}">
                    <i class="fas fa-chevron-left"></i>
                </button>
            `;
        }

        // é¡µç 
        for (let i = 1; i <= pagination.pages; i++) {
            if (i === pagination.page) {
                paginationHTML += `
                    <button class="pagination-btn relative inline-flex items-center px-4 py-2 border border-indigo-500 bg-indigo-50 text-sm font-medium text-indigo-600" data-page="${i}">
                        ${i}
                    </button>
                `;
            } else {
                paginationHTML += `
                    <button class="pagination-btn relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50" data-page="${i}">
                        ${i}
                    </button>
                `;
            }
        }

        // ä¸‹ä¸€é¡µ
        if (pagination.has_next) {
            paginationHTML += `
                <button class="pagination-btn relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50" data-page="${pagination.page + 1}">
                    <i class="fas fa-chevron-right"></i>
                </button>
            `;
        }

        paginationContainer.innerHTML = paginationHTML;

        // ç»‘å®šåˆ†é¡µç‚¹å‡»äº‹ä»¶
        paginationContainer.querySelectorAll('.pagination-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                searchCurrentPage = parseInt(this.dataset.page);
                performSearch();
            });
        });

        document.getElementById('pagination').style.display = 'flex';
    }

    // æ˜¾ç¤º/éšè—åŠ è½½çŠ¶æ€
    function showLoading(show) {
        document.getElementById('loadingSpinner').style.display = show ? 'block' : 'none';
    }

    // æ˜¾ç¤ºæ— ç»“æœæç¤º
    function showNoResults() {
        document.getElementById('noResults').style.display = 'block';
        document.getElementById('propertyList').innerHTML = '';
        document.getElementById('pagination').style.display = 'none';
        document.getElementById('resultCount').textContent = 'æ‰¾åˆ° 0 ä¸ªæˆ¿æº';
    }

    // æ¸…é™¤ç­›é€‰æ¡ä»¶
    function clearFilters() {
        document.getElementById('location').value = '';
        document.getElementById('price').value = '';
        document.getElementById('type').value = '';
        document.getElementById('sortBy').value = 'created_at_desc';

        // éšè—æœç´¢ç»“æœï¼Œæ˜¾ç¤ºé»˜è®¤åˆ—è¡¨
        document.getElementById('searchResults').style.display = 'none';
        document.getElementById('defaultPropertyList').style.display = 'block';

        currentSearchParams = {};
        searchCurrentPage = 1;

        // é‡æ–°åŠ è½½é»˜è®¤åˆ—è¡¨
        fetchListings();
    }

    // é‡ç½®åˆ°é»˜è®¤çŠ¶æ€
    function resetToDefault() {
        // æ¸…ç©ºæ‰€æœ‰ç­›é€‰æ¡ä»¶
        document.getElementById('location').value = '';
        document.getElementById('price').value = '';
        document.getElementById('type').value = '';
        document.getElementById('sortBy').value = 'created_at_desc';

        // åˆ‡æ¢åˆ°é»˜è®¤è§†å›¾
        showDefaultView();

        // é‡ç½®æœç´¢çŠ¶æ€
        currentSearchParams = {};
        searchCurrentPage = 1;

        // é‡æ–°åŠ è½½é»˜è®¤åˆ—è¡¨
        fetchListings();
    }

    // æ˜¾ç¤ºé»˜è®¤è§†å›¾
    function showDefaultView() {
        document.getElementById('searchResults').style.display = 'none';
        document.getElementById('defaultPropertyList').style.display = 'block';
    }

    // æ˜¾ç¤ºæœç´¢è§†å›¾
    function showSearchView() {
        document.getElementById('searchResults').style.display = 'block';
        document.getElementById('defaultPropertyList').style.display = 'none';
    }

    // å¤„ç†æ’åºå˜åŒ–
    function handleSortChange() {
        const searchResultsVisible = document.getElementById('searchResults').style.display !== 'none';

        if (searchResultsVisible) {
            // å¦‚æœåœ¨æœç´¢æ¨¡å¼ï¼Œä½¿ç”¨æœç´¢æ’åº
            performSearch();
        } else {
            // å¦‚æœåœ¨é»˜è®¤æ¨¡å¼ï¼Œå¯¹å½“å‰åˆ—è¡¨è¿›è¡Œæ’åº
            sortCurrentListings();
        }
    }

    // å¯¹å½“å‰åˆ—è¡¨è¿›è¡Œæ’åº
    function sortCurrentListings() {
        const sortValue = document.getElementById('sortBy').value;
        const [sortBy, sortOrder] = sortValue.split('_');

        if (!listings || listings.length === 0) {
            return;
        }

        // åˆ›å»ºæ’åºåçš„å‰¯æœ¬
        const sortedListings = [...listings];

        // æ‰§è¡Œæ’åº
        sortedListings.sort((a, b) => {
            let aValue, bValue;

            switch (sortBy) {
                case 'price':
                    aValue = parseFloat(a.price) || 0;
                    bValue = parseFloat(b.price) || 0;
                    break;
                case 'created_at':
                    aValue = new Date(a.created_at);
                    bValue = new Date(b.created_at);
                    break;
                case 'name':
                    aValue = a.name || '';
                    bValue = b.name || '';
                    break;
                default:
                    return 0;
            }

            if (sortOrder === 'asc') {
                return aValue > bValue ? 1 : aValue < bValue ? -1 : 0;
            } else {
                return aValue < bValue ? 1 : aValue > bValue ? -1 : 0;
            }
        });

        // æ›´æ–°listingså¹¶é‡æ–°æ¸²æŸ“
        listings = sortedListings;
        renderListings();
    }

    // é¢„çº¦çœ‹æˆ¿è¡¨å•å¤„ç†
    function initializeAppointmentForm() {
        const appointmentForm = document.getElementById('appointmentForm');
        if (appointmentForm) {
            appointmentForm.addEventListener('submit', handleAppointmentSubmit);
        }
    }

    // å¤„ç†é¢„çº¦è¡¨å•æäº¤
    async function handleAppointmentSubmit(event) {
        event.preventDefault();

        const submitBtn = document.getElementById('appointmentSubmitBtn');
        const submitText = document.getElementById('appointmentSubmitText');
        const submitLoading = document.getElementById('appointmentSubmitLoading');

        try {
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            submitBtn.disabled = true;
            submitText.classList.add('hidden');
            submitLoading.classList.remove('hidden');

            // è·å–è¡¨å•æ•°æ®
            const formData = new FormData(event.target);
            const appointmentData = {
                property_id: parseInt(formData.get('property_id')),
                name: formData.get('name'),
                phone: formData.get('phone'),
                email: formData.get('email') || '',
                preferred_date: formData.get('preferred_date'),
                preferred_time: formData.get('preferred_time'),
                message: formData.get('message') || ''
            };

            // éªŒè¯å¿…å¡«å­—æ®µ
            if (!appointmentData.name || !appointmentData.phone || !appointmentData.preferred_date || !appointmentData.preferred_time) {
                throw new Error('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µ');
            }

            // æäº¤é¢„çº¦
            const response = await fetch('/api/appointments', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(appointmentData)
            });

            const result = await response.json();

            if (result.success) {
                // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                showAppointmentMessage('é¢„çº¦æäº¤æˆåŠŸï¼æˆ‘ä»¬ä¼šå°½å¿«è”ç³»æ‚¨ç¡®è®¤çœ‹æˆ¿æ—¶é—´ã€‚', 'success');

                // é‡ç½®è¡¨å•
                event.target.reset();
            } else {
                throw new Error(result.message || 'é¢„çº¦æäº¤å¤±è´¥');
            }

        } catch (error) {
            console.error('é¢„çº¦æäº¤å¤±è´¥:', error);
            showAppointmentMessage(error.message || 'é¢„çº¦æäº¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
        } finally {
            // æ¢å¤æŒ‰é’®çŠ¶æ€
            submitBtn.disabled = false;
            submitText.classList.remove('hidden');
            submitLoading.classList.add('hidden');
        }
    }

    // æ˜¾ç¤ºé¢„çº¦æ¶ˆæ¯
    function showAppointmentMessage(message, type = 'info') {
        // åˆ›å»ºæ¶ˆæ¯å…ƒç´ 
        const messageDiv = document.createElement('div');
        messageDiv.className = `fixed top-4 right-4 z-50 px-4 py-3 rounded-md text-white max-w-sm ${
            type === 'success' ? 'bg-green-500' :
            type === 'error' ? 'bg-red-500' : 'bg-blue-500'
        }`;

        messageDiv.innerHTML = `
            <div class="flex items-center">
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'} mr-2"></i>
                <span>${message}</span>
            </div>
        `;

        document.body.appendChild(messageDiv);

        // 5ç§’åè‡ªåŠ¨ç§»é™¤
        setTimeout(() => {
            if (document.body.contains(messageDiv)) {
                document.body.removeChild(messageDiv);
            }
        }, 5000);
    }

    // å¤„ç†URLä¸­çš„é¢„çº¦å‚æ•°
    async function handleUrlAppointmentParams(params) {
        try {
            // éªŒè¯å¿…å¡«å­—æ®µ
            if (!params.property_id || !params.name || !params.phone || !params.preferred_date || !params.preferred_time) {
                console.log('é¢„çº¦å‚æ•°ä¸å®Œæ•´ï¼Œè·³è¿‡è‡ªåŠ¨æäº¤');
                return;
            }

            // æ„å»ºé¢„çº¦æ•°æ®
            const appointmentData = {
                property_id: parseInt(params.property_id),
                name: params.name,
                phone: params.phone,
                email: params.email || '',
                preferred_date: params.preferred_date,
                preferred_time: params.preferred_time,
                message: params.message || ''
            };

            console.log('è‡ªåŠ¨æäº¤é¢„çº¦æ•°æ®:', appointmentData);

            // æäº¤é¢„çº¦
            const response = await fetch('/api/appointments', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(appointmentData)
            });

            const result = await response.json();

            if (result.success) {
                // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                showAppointmentMessage('é¢„çº¦æäº¤æˆåŠŸï¼æˆ‘ä»¬ä¼šå°½å¿«è”ç³»æ‚¨ç¡®è®¤çœ‹æˆ¿æ—¶é—´ã€‚', 'success');

                // å¦‚æœæœ‰hashï¼Œæ»šåŠ¨åˆ°å¯¹åº”æˆ¿æº
                if (window.location.hash) {
                    const targetId = window.location.hash.substring(1);
                    const targetElement = document.getElementById(targetId);
                    if (targetElement) {
                        targetElement.scrollIntoView({ behavior: 'smooth' });
                    }
                }
            } else {
                throw new Error(result.message || 'é¢„çº¦æäº¤å¤±è´¥');
            }

        } catch (error) {
            console.error('è‡ªåŠ¨é¢„çº¦æäº¤å¤±è´¥:', error);
            showAppointmentMessage('é¢„çº¦æäº¤å¤±è´¥: ' + error.message, 'error');
        }
    }
</script>
    <script src="/static/js/swiper-bundle.min.js"></script>
</body>
</html>